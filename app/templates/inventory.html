{% extends "base.html" %}
{% block title_key %}inventory_page_title{% endblock %}
{% block title %}Gestion d'Inventaire - SME Management{% endblock %}

{% block content %}
<main class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8" x-data="inventoryManager()">
    <!-- Page Header -->
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900" data-i18n="inventory_header">Gestion d'Inventaire</h1>
        <p class="text-gray-600 mt-2" data-i18n="inventory_description">GÃ©rez vos produits, stock et approvisionnements</p>
    </div>

    <!-- Inventory Stats -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <i class="fas fa-boxes text-2xl text-blue-600"></i>
                </div>
                <div class="ml-4">
                    <h3 class="text-sm font-medium text-gray-500" data-i18n="inventory_total_products">Total Produits</h3>
                    <p class="text-2xl font-bold text-gray-900" id="totalProducts" x-text="stats.total">0</p>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <i class="fas fa-check-circle text-2xl text-green-600"></i>
                </div>
                <div class="ml-4">
                    <h3 class="text-sm font-medium text-gray-500">En Stock</h3>
                    <p class="text-2xl font-bold text-gray-900" id="inStockProducts" x-text="stats.in_stock">0</p>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <i class="fas fa-exclamation-triangle text-2xl text-yellow-600"></i>
                </div>
                <div class="ml-4">
                    <h3 class="text-sm font-medium text-gray-500">Stock Faible</h3>
                    <p class="text-2xl font-bold text-gray-900" id="lowStockProducts" x-text="stats.low_stock">0</p>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <i class="fas fa-dollar-sign text-2xl text-purple-600"></i>
                </div>
                <div class="ml-4">
                    <h3 class="text-sm font-medium text-gray-500">Valeur Stock</h3>
                    <p class="text-2xl font-bold text-gray-900" id="stockValue" x-text="formatCurrency(stats.inventory_value)">0</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="flex flex-wrap gap-4 mb-6">
        <button @click="showProductModal = true" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg flex items-center">
            <i class="fas fa-plus mr-2"></i>
            <span data-i18n="inventory_add_product">Ajouter Produit</span>
        </button>
        
        <div class="relative" x-data="{ open: false }">
            <button @click="open = !open" class="bg-gray-600 hover:bg-gray-700 text-white px-6 py-2 rounded-lg flex items-center">
                <i class="fas fa-exchange-alt mr-2"></i>
                <span data-i18n="inventory_import_export">Import/Export</span>
                <i class="fas fa-chevron-down ml-2"></i>
            </button>
            <div x-show="open" @click.away="open = false" class="absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 z-50">
                <button @click="exportInventory(); open = false" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                    <i class="fas fa-download mr-2"></i><span data-i18n="inventory_export_inventory">ðŸ“¤ Exporter Inventaire</span>
                </button>
                <button @click="importProducts(); open = false" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                    <i class="fas fa-upload mr-2"></i><span data-i18n="inventory_import_products">ðŸ“¥ Importer Produits</span>
                </button>
                <button @click="generateInventoryReport(); open = false" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                    <i class="fas fa-chart-bar mr-2"></i><span data-i18n="inventory_report_inventory">ðŸ“Š Rapport d'Inventaire</span>
                </button>
            </div>
        </div>
        
        <div class="relative" x-data="{ open: false }">
            <button @click="open = !open" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg flex items-center">
                <i class="fas fa-cogs mr-2"></i>
                <span data-i18n="inventory_actions">Actions</span>
                <i class="fas fa-chevron-down ml-2"></i>
            </button>
            <div x-show="open" @click.away="open = false" class="absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 z-50">
                <button @click="showInventoryCountModal = true; open = false" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                    <i class="fas fa-clipboard-list mr-2"></i><span data-i18n="inventory_count">ðŸ”¢ Comptage d'Inventaire</span>
                </button>
                <button @click="showBatchOperationsModal = true; open = false" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                    <i class="fas fa-tasks mr-2"></i><span data-i18n="inventory_batch_operations">ðŸ“‹ OpÃ©rations par Lot</span>
                </button>
                <button @click="viewStockHistory(); open = false" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                    <i class="fas fa-history mr-2"></i><span data-i18n="inventory_history">ðŸ“œ Historique d'Inventaire</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="bg-white rounded-lg shadow p-6 mb-6">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Rechercher</label>
                <input type="text" x-model="searchTerm" placeholder="Nom, code-barres..." class="w-full border border-gray-300 rounded-md px-3 py-2">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">CatÃ©gorie</label>
                <select x-model="categoryFilter" class="w-full border border-gray-300 rounded-md px-3 py-2">
                    <option value="">Toutes les catÃ©gories</option>
                    <template x-for="category in categories" :key="category.category">
                        <option :value="category.category" x-text="category.category + ' (' + category.product_count + ')'"></option>
                    </template>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Stock</label>
                <select x-model="stockFilter" class="w-full border border-gray-300 rounded-md px-3 py-2">
                    <option value="">Tous les stocks</option>
                    <option value="normal">Stock normal</option>
                    <option value="low">Stock faible</option>
                    <option value="out">Rupture de stock</option>
                </select>
            </div>
            <div class="flex items-end">
                <button @click="loadProducts()" class="w-full bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md">
                    <i class="fas fa-search mr-2"></i>Filtrer
                </button>
            </div>
        </div>
    </div>

    <!-- Loading State -->
    <div id="loadingState" x-show="isLoading" class="text-center py-8">
        <i class="fas fa-spinner fa-spin text-4xl text-blue-600 mb-4"></i>
        <p class="text-gray-600">Chargement des produits...</p>
    </div>

    <!-- Products Container -->
    <div id="productsContainer" x-show="!isLoading">
        <!-- Products Grid -->
        <div id="gridView" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
            <template x-for="product in filteredProducts" :key="product.id">
                <div class="bg-white rounded-lg shadow-lg overflow-hidden hover:shadow-xl transition-shadow duration-300">
                    <div class="p-6">
                        <div class="flex justify-between items-start mb-4">
                            <h3 class="text-lg font-semibold text-gray-900" x-text="product.name"></h3>
                            <span class="px-2 py-1 text-xs font-medium rounded-full"
                                  :class="{
                                      'bg-red-100 text-red-800': product.current_stock === 0,
                                      'bg-yellow-100 text-yellow-800': product.current_stock > 0 && product.current_stock <= product.min_stock_alert,
                                      'bg-green-100 text-green-800': product.current_stock > product.min_stock_alert
                                  }">
                                <span x-text="getStockStatus(product)"></span>
                            </span>
                        </div>
                        
                        <p class="text-gray-600 text-sm mb-4" x-text="product.description || 'Aucune description'"></p>
                        
                        <div class="space-y-2 mb-4">
                            <div class="flex justify-between">
                                <span class="text-gray-500">CatÃ©gorie:</span>
                                <span x-text="product.category || 'Non classÃ©'"></span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-500">Prix de vente:</span>
                                <span class="font-semibold" x-text="formatCurrency(product.sale_price)"></span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-500">Stock actuel:</span>
                                <span class="font-bold" x-text="product.current_stock"></span>
                            </div>
                        </div>
                        
                        <div class="flex space-x-2">
                            <button @click="editProduct(product)" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-2 px-3 rounded-md text-sm">
                                <i class="fas fa-edit mr-1"></i>Ã‰diter
                            </button>
                            <button @click="adjustStock(product)" class="flex-1 bg-green-600 hover:bg-green-700 text-white py-2 px-3 rounded-md text-sm">
                                <i class="fas fa-plus-minus mr-1"></i>Stock
                            </button>
                        </div>
                    </div>
                </div>
            </template>
        </div>

        <!-- Empty State -->
        <div id="emptyState" x-show="filteredProducts.length === 0 && !isLoading" class="text-center py-12">
            <i class="fas fa-box-open text-6xl text-gray-300 mb-4"></i>
            <h3 class="text-lg font-medium text-gray-900 mb-2">Aucun produit trouvÃ©</h3>
            <p class="text-gray-500 mb-6">Commencez par ajouter votre premier produit</p>
            <button @click="showProductModal = true" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg">
                <i class="fas fa-plus mr-2"></i>Ajouter un produit
            </button>
        </div>
    </div>

    <!-- Product Modal -->
    <div x-show="showProductModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50" x-cloak>
        <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-2/3 lg:w-1/2 shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-medium text-gray-900" x-text="editMode ? 'Modifier le produit' : 'Nouveau produit'"></h3>
                    <button @click="closeProductModal()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <form @submit.prevent="saveProduct()">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Nom du produit*</label>
                            <input type="text" x-model="productForm.name" class="w-full border border-gray-300 rounded-md px-3 py-2" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">CatÃ©gorie</label>
                            <input type="text" x-model="productForm.category" class="w-full border border-gray-300 rounded-md px-3 py-2" placeholder="Ex: Outils, MatÃ©riaux">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Prix d'achat*</label>
                            <input type="number" x-model="productForm.purchase_price" step="0.01" min="0" class="w-full border border-gray-300 rounded-md px-3 py-2" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Prix de vente*</label>
                            <input type="number" x-model="productForm.sale_price" step="0.01" min="0" class="w-full border border-gray-300 rounded-md px-3 py-2" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Stock initial</label>
                            <input type="number" x-model="productForm.current_stock" min="0" class="w-full border border-gray-300 rounded-md px-3 py-2">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Seuil d'alerte</label>
                            <input type="number" x-model="productForm.min_stock_alert" min="0" class="w-full border border-gray-300 rounded-md px-3 py-2">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Fournisseur</label>
                            <input type="text" x-model="productForm.supplier" class="w-full border border-gray-300 rounded-md px-3 py-2">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Code-barres</label>
                            <input type="text" x-model="productForm.barcode" class="w-full border border-gray-300 rounded-md px-3 py-2">
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                        <textarea x-model="productForm.description" class="w-full border border-gray-300 rounded-md px-3 py-2" rows="3"></textarea>
                    </div>
                    
                    <div class="flex justify-end space-x-3">
                        <button type="button" @click="closeProductModal()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded-md">
                            Annuler
                        </button>
                        <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md" :disabled="isLoading">
                            <i class="fas fa-spinner fa-spin mr-2" x-show="isLoading"></i>
                            <span x-text="editMode ? 'Mettre Ã  jour' : 'CrÃ©er'"></span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Stock Adjustment Modal -->
    <div x-show="showStockModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50" x-cloak>
        <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-1/2 shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-medium text-gray-900">Ajuster le Stock</h3>
                    <button @click="showStockModal = false" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div class="mb-4">
                    <h4 class="font-medium text-gray-900" x-text="stockAdjustment.product_name"></h4>
                    <p class="text-sm text-gray-500">Stock actuel: <span x-text="stockAdjustment.current_stock"></span></p>
                </div>
                
                <form @submit.prevent="saveStockAdjustment()">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Type d'ajustement</label>
                            <select x-model="stockAdjustment.adjustment_type" class="w-full border border-gray-300 rounded-md px-3 py-2" required>
                                <option value="add">Ajouter au stock</option>
                                <option value="subtract">Retirer du stock</option>
                                <option value="set">DÃ©finir le stock</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">QuantitÃ©</label>
                            <input type="number" x-model="stockAdjustment.quantity" min="0" class="w-full border border-gray-300 rounded-md px-3 py-2" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">RÃ©fÃ©rence</label>
                            <input type="text" x-model="stockAdjustment.reference" class="w-full border border-gray-300 rounded-md px-3 py-2" placeholder="Ex: Livraison #123">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Notes</label>
                            <textarea x-model="stockAdjustment.notes" class="w-full border border-gray-300 rounded-md px-3 py-2" rows="3"></textarea>
                        </div>
                    </div>
                    
                    <div class="flex justify-end space-x-3 mt-6">
                        <button type="button" @click="showStockModal = false" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded-md">
                            Annuler
                        </button>
                        <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md">
                            Ajuster
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</main>
{% endblock %}

{% block extra_scripts %}
<script>
function inventoryManager() {
    return {
        products: [],
        categories: [],
        stats: {
            total: 0,
            in_stock: 0,
            low_stock: 0,
            out_of_stock: 0,
            inventory_value: 0
        },
        isLoading: true,
        searchTerm: '',
        categoryFilter: '',
        stockFilter: '',
        showProductModal: false,
        showStockModal: false,
        showInventoryCountModal: false,
        editMode: false,
        selectedProductId: null,
        productForm: {
            name: '',
            description: '',
            category: '',
            purchase_price: '',
            sale_price: '',
            current_stock: 0,
            min_stock_alert: 5,
            supplier: '',
            barcode: ''
        },
        stockAdjustment: {
            product_id: null,
            product_name: '',
            current_stock: 0,
            adjustment_type: 'add',
            quantity: '',
            reference: '',
            notes: ''
        },
        
        init() {
            this.loadProducts();
            this.loadCategories();
            this.loadStats();
        },
        
        async loadProducts() {
            this.isLoading = true;
            try {
                const params = new URLSearchParams();
                if (this.searchTerm) params.append('search', this.searchTerm);
                if (this.categoryFilter) params.append('category', this.categoryFilter);
                if (this.stockFilter) params.append('stock_filter', this.stockFilter);
                
                const response = await apiFetch(`/api/inventory/products?${params}`);
                if (response.success) {
                    this.products = response.products || [];
                    if (response.stats) {
                        this.stats = response.stats;
                    }
                }
            } catch (error) {
                console.error('Error loading products:', error);
                this.showNotification('Erreur lors du chargement des produits', 'error');
            } finally {
                this.isLoading = false;
            }
        },
        
        async loadCategories() {
            try {
                const response = await apiFetch('/api/inventory/categories');
                if (response.success) {
                    this.categories = response.categories || [];
                }
            } catch (error) {
                console.error('Error loading categories:', error);
            }
        },
        
        async loadStats() {
            try {
                const response = await apiFetch('/api/inventory/stats');
                if (response.success) {
                    this.stats = response.stats;
                }
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        },
        
        get filteredProducts() {
            return this.products.filter(product => {
                const matchesSearch = !this.searchTerm || 
                    product.name.toLowerCase().includes(this.searchTerm.toLowerCase()) ||
                    (product.barcode && product.barcode.includes(this.searchTerm));
                
                const matchesCategory = !this.categoryFilter || product.category === this.categoryFilter;
                
                let matchesStock = true;
                if (this.stockFilter === 'low') {
                    matchesStock = product.current_stock <= product.min_stock_alert && product.current_stock > 0;
                } else if (this.stockFilter === 'out') {
                    matchesStock = product.current_stock === 0;
                } else if (this.stockFilter === 'normal') {
                    matchesStock = product.current_stock > product.min_stock_alert;
                }
                
                return matchesSearch && matchesCategory && matchesStock;
            });
        },
        
        editProduct(product) {
            this.editMode = true;
            this.selectedProductId = product.id;
            this.productForm = {
                name: product.name,
                description: product.description || '',
                category: product.category || '',
                purchase_price: product.purchase_price,
                sale_price: product.sale_price,
                current_stock: product.current_stock,
                min_stock_alert: product.min_stock_alert,
                supplier: product.supplier || '',
                barcode: product.barcode || ''
            };
            this.showProductModal = true;
        },
        
        adjustStock(product) {
            this.stockAdjustment = {
                product_id: product.id,
                product_name: product.name,
                current_stock: product.current_stock,
                adjustment_type: 'add',
                quantity: '',
                reference: '',
                notes: ''
            };
            this.showStockModal = true;
        },
        
        async saveProduct() {
            try {
                const url = this.editMode ? `/api/inventory/products/${this.selectedProductId}` : '/api/inventory/products';
                const method = this.editMode ? 'PUT' : 'POST';
                
                const response = await apiFetch(url, {
                    method: method,
                    body: this.productForm
                });
                
                if (response.success) {
                    this.closeProductModal();
                    this.loadProducts();
                    this.loadStats();
                    this.showNotification(
                        this.editMode ? 'Produit mis Ã  jour avec succÃ¨s' : 'Produit crÃ©Ã© avec succÃ¨s',
                        'success'
                    );
                } else {
                    this.showNotification(response.message || 'Erreur lors de la sauvegarde', 'error');
                }
            } catch (error) {
                console.error('Error saving product:', error);
                this.showNotification('Erreur lors de la sauvegarde du produit', 'error');
            }
        },
        
        async saveStockAdjustment() {
            try {
                const response = await apiFetch('/api/inventory/adjust-stock', {
                    method: 'POST',
                    body: this.stockAdjustment
                });
                
                if (response.success) {
                    this.showStockModal = false;
                    this.loadProducts();
                    this.loadStats();
                    this.showNotification('Stock ajustÃ© avec succÃ¨s', 'success');
                } else {
                    this.showNotification(response.message || 'Erreur lors de l\'ajustement', 'error');
                }
            } catch (error) {
                console.error('Error adjusting stock:', error);
                this.showNotification('Erreur lors de l\'ajustement du stock', 'error');
            }
        },
        
        closeProductModal() {
            this.showProductModal = false;
            this.editMode = false;
            this.selectedProductId = null;
            this.productForm = {
                name: '',
                description: '',
                category: '',
                purchase_price: '',
                sale_price: '',
                current_stock: 0,
                min_stock_alert: 5,
                supplier: '',
                barcode: ''
            };
        },
        
        getStockStatus(product) {
            if (product.current_stock === 0) {
                return 'Rupture';
            } else if (product.current_stock <= product.min_stock_alert) {
                return 'Stock faible';
            } else {
                return 'En stock';
            }
        },
        
        exportInventory() {
            window.open('/api/reports/export/products', '_blank');
        },
        
        importProducts() {
            this.showNotification('FonctionnalitÃ© d\'import en cours de dÃ©veloppement', 'info');
        },
        
        generateInventoryReport() {
            window.open('/api/reports/inventory-report', '_blank');
        },
        
        viewStockHistory() {
            window.open('/api/inventory/stock-movements', '_blank');
        },
        
        formatCurrency(amount) {
            return window.formatCurrency ? window.formatCurrency(amount) : `${amount} MRU`;
        },
        
        showNotification(message, type = 'info') {
            if (window.showNotification) {
                window.showNotification(message, type);
            } else {
                alert(message);
            }
        }
    };
}
</script>
<style>
[x-cloak] { display: none !important; }
</style>
{% endblock %}