{% extends 'base.html' %}

{% block title %}Finance - Quincaillerie Management{% endblock %}

{% block extra_head %}
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
{% endblock %}

{% block content %}
<main class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8" x-data="financeManager()" x-init="init()">
        <!-- Page Header -->
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-gray-900">Gestion Financière</h1>
            <p class="text-gray-600 mt-2">Suivez vos revenus, dépenses et performance financière</p>
        </div>

        <!-- Financial Summary Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <i class="fas fa-dollar-sign text-2xl text-green-600"></i>
                    </div>
                    <div class="ml-4 flex-1">
                        <h3 class="text-sm font-medium text-gray-500">Revenus Total</h3>
                        <p class="text-2xl font-bold text-gray-900" x-text="summary.total_revenue">0 MRU</p>
                        <p class="text-sm text-green-600">+12% ce mois</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <i class="fas fa-credit-card text-2xl text-red-600"></i>
                    </div>
                    <div class="ml-4 flex-1">
                        <h3 class="text-sm font-medium text-gray-500">Dépenses Total</h3>
                        <p class="text-2xl font-bold text-gray-900" x-text="summary.total_expenses">0 MRU</p>
                        <p class="text-sm text-red-600">+8% ce mois</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <i class="fas fa-chart-line text-2xl text-blue-600"></i>
                    </div>
                    <div class="ml-4 flex-1">
                        <h3 class="text-sm font-medium text-gray-500">Bénéfice Net</h3>
                        <p class="text-2xl font-bold text-gray-900" x-text="summary.net_profit">0 MRU</p>
                        <p class="text-sm text-blue-600">+15% ce mois</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <i class="fas fa-wallet text-2xl text-purple-600"></i>
                    </div>
                    <div class="ml-4 flex-1">
                        <h3 class="text-sm font-medium text-gray-500">Solde Caisse</h3>
                        <p class="text-2xl font-bold text-gray-900" x-text="summary.cash_balance">0 MRU</p>
                        <p class="text-sm text-gray-500">Dernière MAJ: Aujourd'hui</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <!-- Revenue Chart -->
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-medium text-gray-900">Évolution des Revenus</h3>
                    <select x-model="chartPeriod" @change="updateCharts()" class="border border-gray-300 rounded-md px-3 py-1 text-sm">
                        <option value="week">7 derniers jours</option>
                        <option value="month">30 derniers jours</option>
                        <option value="year">12 derniers mois</option>
                    </select>
                </div>
                <div class="h-64">
                    <canvas id="revenueChart"></canvas>
                </div>
            </div>
            
            <!-- Expense Breakdown -->
            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-lg font-medium text-gray-900 mb-4">Répartition des Dépenses</h3>
                <div class="h-64">
                    <canvas id="expenseChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="flex flex-wrap gap-4 mb-6">
            <button @click="showTransactionModal = true" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg flex items-center">
                <i class="fas fa-plus mr-2"></i>
                Nouvelle Transaction
            </button>
            <button @click="showExpenseModal = true" class="bg-red-600 hover:bg-red-700 text-white px-6 py-2 rounded-lg flex items-center">
                <i class="fas fa-minus mr-2"></i>
                Nouvelle Dépense
            </button>
            <button @click="generateFinanceReport()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg flex items-center">
                <i class="fas fa-file-excel mr-2"></i>
                Rapport Financier
            </button>
            <button @click="backupData()" class="bg-gray-600 hover:bg-gray-700 text-white px-6 py-2 rounded-lg flex items-center">
                <i class="fas fa-save mr-2"></i>
                Sauvegarde
            </button>
        </div>

        <!-- Recent Transactions -->
        <div class="bg-white shadow rounded-lg overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-200">
                <div class="flex justify-between items-center">
                    <h3 class="text-lg font-medium text-gray-900">Transactions Récentes</h3>
                    <div class="flex space-x-2">
                        <input type="text" x-model="searchTerm" placeholder="Rechercher..." class="border border-gray-300 rounded-md px-3 py-2 text-sm">
                        <select x-model="filterType" class="border border-gray-300 rounded-md px-3 py-2 text-sm">
                            <option value="">Tous types</option>
                            <option value="income">Revenus</option>
                            <option value="expense">Dépenses</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Description</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Montant</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Catégorie</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        <template x-for="transaction in filteredTransactions" :key="transaction.id">
                            <tr class="hover:bg-gray-50">
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="formatDate(transaction.date)"></td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" x-text="transaction.description"></td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full"
                                          :class="{
                                              'bg-green-100 text-green-800': transaction.type === 'income',
                                              'bg-red-100 text-red-800': transaction.type === 'expense'
                                          }"
                                          x-text="transaction.type === 'income' ? 'Revenu' : 'Dépense'">
                                    </span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium"
                                    :class="{
                                        'text-green-600': transaction.type === 'income',
                                        'text-red-600': transaction.type === 'expense'
                                    }">
                                    <span x-text="(transaction.type === 'income' ? '+' : '-') + transaction.amount + ' MRU'"></span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="transaction.category"></td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                    <button @click="editTransaction(transaction)" class="text-blue-600 hover:text-blue-900 mr-3">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button @click="deleteTransaction(transaction)" class="text-red-600 hover:text-red-900">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        </template>
                        
                        <tr x-show="filteredTransactions.length === 0">
                            <td colspan="6" class="px-6 py-4 text-center text-gray-500">
                                <div class="flex flex-col items-center">
                                    <i class="fas fa-receipt text-4xl text-gray-300 mb-2"></i>
                                    <p>Aucune transaction trouvée</p>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Transaction Modal -->
        <div x-show="showTransactionModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50" x-cloak>
            <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-1/2 shadow-lg rounded-md bg-white">
                <div class="mt-3">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-medium text-gray-900">Nouvelle Transaction</h3>
                        <button @click="showTransactionModal = false" class="text-gray-400 hover:text-gray-600">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    
                    <form @submit.prevent="createTransaction()">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Type</label>
                                <select x-model="newTransaction.type" class="w-full border border-gray-300 rounded-md px-3 py-2" required>
                                    <option value="income">Revenu</option>
                                    <option value="expense">Dépense</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Montant (MRU)</label>
                                <input type="number" x-model="newTransaction.amount" step="0.01" min="0" class="w-full border border-gray-300 rounded-md px-3 py-2" required>
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                            <input type="text" x-model="newTransaction.description" class="w-full border border-gray-300 rounded-md px-3 py-2" required>
                        </div>
                        
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Catégorie</label>
                            <select x-model="newTransaction.category" class="w-full border border-gray-300 rounded-md px-3 py-2" required>
                                <option value="">Sélectionner une catégorie</option>
                                <template x-for="category in categories" :key="category">
                                    <option :value="category" x-text="category"></option>
                                </template>
                            </select>
                        </div>
                        
                        <div class="flex justify-end space-x-3">
                            <button type="button" @click="showTransactionModal = false" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded-md">
                                Annuler
                            </button>
                            <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md">
                                Créer Transaction
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-slate-800 text-white py-4 mt-12">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex justify-between items-center">
            <p>&copy; {{ current_year }} Quincaillerie Management v{{ app_version }}</p>
            <div class="flex items-center space-x-4">
                <span class="text-green-400"><i class="fas fa-circle text-xs"></i> En ligne</span>
                <span>Mode: {{ user_role|title }}</span>
                <span>Utilisateur: {{ current_user }}</span>
            </div>
        </div>
    </footer>
{% endblock %}

{% block extra_scripts %}
    <script>
        function financeManager() {
            return {
                summary: {
                    total_revenue: '0 MRU',
                    total_expenses: '0 MRU',
                    net_profit: '0 MRU',
                    cash_balance: '0 MRU'
                },
                transactions: [],
                categories: ['Ventes', 'Achats', 'Salaires', 'Loyer', 'Électricité', 'Maintenance', 'Marketing', 'Divers'],
                showTransactionModal: false,
                showExpenseModal: false,
                newTransaction: {
                    type: 'income',
                    amount: '',
                    description: '',
                    category: ''
                },
                searchTerm: '',
                filterType: '',
                chartPeriod: 'month',
                revenueChart: null,
                expenseChart: null,
                
                init() {
                    this.loadData();
                    this.$nextTick(() => {
                        this.initCharts();
                    });
                },
                
                loadData() {
                    // Load financial summary
                    apiFetch('/api/finance/summary')
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                this.summary = data.summary;
                            }
                        })
                        .catch(error => console.error('Error loading summary:', error));
                    
                    // Load transactions history
                    apiFetch('/api/finance/transactions')
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                this.transactions = data.transactions || [];
                            }
                        })
                        .catch(error => console.error('Error loading transactions:', error));
                },
                
                get filteredTransactions() {
                    return this.transactions.filter(transaction => {
                        const matchesSearch = !this.searchTerm || 
                            transaction.description.toLowerCase().includes(this.searchTerm.toLowerCase());
                        const matchesType = !this.filterType || transaction.type === this.filterType;
                        return matchesSearch && matchesType;
                    });
                },
                
                initCharts() {
                    const revenueCtx = document.getElementById('revenueChart').getContext('2d');
                    const expenseCtx = document.getElementById('expenseChart').getContext('2d');

                    this.revenueChart = new Chart(revenueCtx, {
                        type: 'line',
                        data: { labels: [], datasets: [{ label: 'Revenus (MRU)', data: [], borderColor: 'rgb(59, 130, 246)', backgroundColor: 'rgba(59, 130, 246, 0.1)', tension: 0.4 }] },
                        options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
                    });

                    this.expenseChart = new Chart(expenseCtx, {
                        type: 'doughnut',
                        data: { labels: [], datasets: [{ data: [], backgroundColor: ['rgb(239, 68, 68)','rgb(245, 158, 11)','rgb(34, 197, 94)','rgb(168, 85, 247)','rgb(107, 114, 128)'] }] },
                        options: { responsive: true, maintainAspectRatio: false }
                    });

                    // Load chart data from reports API
                    apiFetch('/api/reports/financial-report')
                        .then(r => r.json())
                        .then(data => {
                            if (data.success) {
                                const perf = data.report.daily_performance || [];
                                this.revenueChart.data.labels = perf.map(p => p.date);
                                this.revenueChart.data.datasets[0].data = perf.map(p => p.revenue);
                                this.revenueChart.update();

                                const breakdown = data.report.expenses_breakdown || [];
                                this.expenseChart.data.labels = breakdown.map(b => b.subcategory || b.category);
                                this.expenseChart.data.datasets[0].data = breakdown.map(b => b.total_amount);
                                this.expenseChart.update();
                            }
                        })
                        .catch(error => console.error('Error loading chart data:', error));
                },
                
                updateCharts() {
                    const params = new URLSearchParams();
                    if (this.chartPeriod === 'week') {
                        params.append('start_date', new Date(Date.now() - 7*24*60*60*1000).toISOString().split('T')[0]);
                    } else if (this.chartPeriod === 'month') {
                        params.append('start_date', new Date(Date.now() - 30*24*60*60*1000).toISOString().split('T')[0]);
                    } else if (this.chartPeriod === 'year') {
                        params.append('start_date', new Date(Date.now() - 365*24*60*60*1000).toISOString().split('T')[0]);
                    }
                    apiFetch(`/api/reports/financial-report?${params.toString()}`)
                        .then(r => r.json())
                        .then(data => {
                            if (data.success) {
                                const perf = data.report.daily_performance || [];
                                this.revenueChart.data.labels = perf.map(p => p.date);
                                this.revenueChart.data.datasets[0].data = perf.map(p => p.revenue);
                                this.revenueChart.update();

                                const breakdown = data.report.expenses_breakdown || [];
                                this.expenseChart.data.labels = breakdown.map(b => b.subcategory || b.category);
                                this.expenseChart.data.datasets[0].data = breakdown.map(b => b.total_amount);
                                this.expenseChart.update();
                            }
                        })
                        .catch(err => console.error('Error updating charts:', err));
                },
                
                createTransaction() {
                    const today = new Date().toISOString().split('T')[0];
                    const isIncome = this.newTransaction.type === 'income';
                    const url = isIncome ? '/api/finance/capital' : '/api/finance/expenses';

                    const payload = isIncome ? {
                        amount: this.newTransaction.amount,
                        source: this.newTransaction.description,
                        entry_date: today
                    } : {
                        amount: this.newTransaction.amount,
                        category: this.newTransaction.category || 'Divers',
                        description: this.newTransaction.description,
                        expense_date: today
                    };

                    apiFetch(url, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(payload)
                    })
                        .then(r => r.json())
                        .then(data => {
                            if (data.success) {
                                this.loadData();
                                this.showTransactionModal = false;
                                this.newTransaction = {type: 'income', amount: '', description: '', category: ''};
                                alert('Transaction créée avec succès!');
                            } else {
                                alert(data.message || 'Erreur lors de la création');
                            }
                        })
                        .catch(err => console.error('Error creating transaction:', err));
                },
                
                editTransaction(transaction) {
                    alert('Éditer transaction #' + transaction.id);
                },
                
                deleteTransaction(transaction) {
                    if (!confirm('Êtes-vous sûr de vouloir supprimer cette transaction?')) return;

                    const url = transaction.type === 'income'
                        ? `/api/finance/capital/${transaction.id}`
                        : `/api/finance/expenses/${transaction.id}`;

                    apiFetch(url, { method: 'DELETE' })
                        .then(r => r.json())
                        .then(data => {
                            if (data.success) {
                                this.transactions = this.transactions.filter(t => t.id !== transaction.id);
                            } else {
                                alert(data.message || 'Erreur lors de la suppression');
                            }
                        })
                        .catch(err => console.error('Error deleting transaction:', err));
                },
                
                generateFinanceReport() {
                    alert('Génération du rapport financier...');
                },
                
                backupData() {
                    alert('Sauvegarde des données financières...');
                },
                
                formatDate(dateString) {
                    return new Date(dateString).toLocaleDateString('fr-FR');
                }
            }
        }
        
        function changeLanguage(lang) {
            window.location.href = `/set-language/${lang}`;
        }
    </script>
    <style>
        [x-cloak] { display: none !important; }
    </style>
{% endblock %}
