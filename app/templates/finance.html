{% extends 'base.html' %}

{% block title %}Finance - Quincaillerie Management{% endblock %}

{% block extra_head %}
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
{% endblock %}

{% block content %}
<main class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8" x-data="financeManager()" x-init="init()">
        <!-- Page Header -->
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-gray-900">Gestion Financière</h1>
            <p class="text-gray-600 mt-2">Suivez vos revenus, dépenses et performance financière</p>
        <!-- Tabs: Summary vs Receivables (visible so deep links are not confusing) -->
        <div class="mt-4 flex items-center gap-2 text-sm">
        <button @click="setTab('summary')"
            :class="activeTab==='summary' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'"
            class="px-3 py-1 rounded-md">Résumé</button>
        <button @click="setTab('receivables')"
            :class="activeTab==='receivables' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'"
            class="px-3 py-1 rounded-md">Créances en retard</button>
        <span x-show="activeTab==='receivables'" class="ml-2 text-xs text-gray-500">(filtré: en retard)</span>
        </div>
        </div>

        <!-- Financial Summary Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <i class="fas fa-dollar-sign text-2xl text-green-600"></i>
                    </div>
                    <div class="ml-4 flex-1">
                        <h3 class="text-sm font-medium text-gray-500">Revenus Total</h3>
                        <p class="text-2xl font-bold text-gray-900" x-text="summary.total_revenue">0 {{ current_currency }}</p>
            <!-- Removed fake delta to avoid misleading metrics -->
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <i class="fas fa-credit-card text-2xl text-red-600"></i>
                    </div>
                    <div class="ml-4 flex-1">
                        <h3 class="text-sm font-medium text-gray-500">Dépenses Total</h3>
                        <p class="text-2xl font-bold text-gray-900" x-text="summary.total_expenses">0 {{ current_currency }}</p>
            <!-- Removed fake delta to avoid misleading metrics -->
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <i class="fas fa-chart-line text-2xl text-blue-600"></i>
                    </div>
                    <div class="ml-4 flex-1">
                        <h3 class="text-sm font-medium text-gray-500">Bénéfice Net</h3>
                        <p class="text-2xl font-bold text-gray-900" x-text="summary.net_profit">0 {{ current_currency }}</p>
            <!-- Removed fake delta to avoid misleading metrics -->
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <i class="fas fa-wallet text-2xl text-purple-600"></i>
                    </div>
                    <div class="ml-4 flex-1">
                        <h3 class="text-sm font-medium text-gray-500">Solde Caisse</h3>
                        <p class="text-2xl font-bold text-gray-900" x-text="summary.cash_balance">0 {{ current_currency }}</p>
                        <p class="text-sm text-gray-500">Dernière MAJ: Aujourd'hui</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <!-- Revenue Chart -->
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-medium text-gray-900">Évolution des Revenus</h3>
                    <select x-model="chartPeriod" @change="updateCharts()" class="border border-gray-300 rounded-md px-3 py-1 text-sm">
                        <option value="week">7 derniers jours</option>
                        <option value="month">30 derniers jours</option>
                        <option value="year">12 derniers mois</option>
                        <option value="all">Tout le temps</option>
                    </select>
                </div>
                <div class="h-64 relative">
                    <div x-show="isLoadingCharts" class="absolute inset-0 flex items-center justify-center text-gray-500">
                        <i class="fas fa-spinner fa-spin mr-2"></i>Chargement du graphique...
                    </div>
                    <canvas id="revenueChart"></canvas>
                </div>
            </div>
            
            <!-- Expense Breakdown -->
            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-lg font-medium text-gray-900 mb-4">Répartition des Dépenses</h3>
                <div class="h-64 relative">
                    <div x-show="isLoadingCharts" class="absolute inset-0 flex items-center justify-center text-gray-500">
                        <i class="fas fa-spinner fa-spin mr-2"></i>Chargement du graphique...
                    </div>
                    <canvas id="expenseChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="flex flex-wrap gap-4 mb-6">
            <button @click="newTransaction.type='income'; showTransactionModal = true" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg flex items-center">
                <i class="fas fa-plus mr-2"></i>
                Nouvelle Transaction
            </button>
            <button @click="newTransaction.type='expense'; showTransactionModal = true" class="bg-red-600 hover:bg-red-700 text-white px-6 py-2 rounded-lg flex items-center">
                <i class="fas fa-minus mr-2"></i>
                Nouvelle Dépense
            </button>
            <button @click="generateFinanceReport()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg flex items-center">
                <i class="fas fa-file-excel mr-2"></i>
                Rapport Financier
            </button>
            <button @click="backupData()" class="bg-gray-600 hover:bg-gray-700 text-white px-6 py-2 rounded-lg flex items-center">
                <i class="fas fa-save mr-2"></i>
                Sauvegarde
            </button>
        </div>

        <!-- Receivables (when navigated with tab=receivables) -->
        <div x-show="activeTab==='receivables'" class="bg-white shadow rounded-lg overflow-hidden mb-8">
            <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
                <h3 class="text-lg font-medium text-gray-900">Créances Clients (en retard)</h3>
                <div>
                    <button @click="loadReceivables(true)" class="text-sm text-blue-600 hover:text-blue-800">Rafraîchir</button>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Client</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Montant dû</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Échéance</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Jours de retard</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        <template x-for="d in receivables" :key="d.id">
                            <tr>
                                <td class="px-6 py-4 text-sm text-gray-900" x-text="d.client_name"></td>
                                <td class="px-6 py-4 text-sm text-gray-900" x-text="window.formatCurrency ? window.formatCurrency(d.remaining_amount) : (Number(d.remaining_amount||0).toFixed(2)+' '+(window.AppConfig?.currentCurrency||'MRU'))"></td>
                                <td class="px-6 py-4 text-sm text-gray-500" x-text="formatDate(d.due_date)"></td>
                                <td class="px-6 py-4 text-sm" :class="(d.days_overdue||0)>0 ? 'text-red-600 font-semibold' : 'text-gray-500'" x-text="d.days_overdue||0"></td>
                            </tr>
                        </template>
                        <tr x-show="receivables.length===0">
                            <td colspan="4" class="px-6 py-4 text-center text-gray-500">Aucune créance en retard</td>
                        </tr>
                    </tbody>
                    <tfoot class="bg-gray-50">
                        <tr>
                            <td class="px-6 py-3 text-right text-sm font-medium" colspan="1">Total</td>
                            <td class="px-6 py-3 text-sm font-semibold" x-text="window.formatCurrency ? window.formatCurrency(receivablesTotal) : (Number(receivablesTotal||0).toFixed(2)+' '+(window.AppConfig?.currentCurrency||'MRU'))"></td>
                            <td colspan="2"></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>

        <!-- Recent Transactions -->
        <div class="bg-white shadow rounded-lg overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-200">
                <div class="flex justify-between items-center">
                    <h3 class="text-lg font-medium text-gray-900">Transactions Récentes</h3>
                    <div class="flex space-x-2">
                        <input type="text" x-model="searchTerm" placeholder="Rechercher..." class="border border-gray-300 rounded-md px-3 py-2 text-sm">
                        <select x-model="filterType" class="border border-gray-300 rounded-md px-3 py-2 text-sm">
                            <option value="">Tous types</option>
                            <option value="income">Revenus</option>
                            <option value="expense">Dépenses</option>
                        </select>
                        <button @click="loadData(); updateCharts();" class="border border-gray-300 rounded-md px-3 py-2 text-sm hover:bg-gray-50">Rafraîchir</button>
                    </div>
                </div>
            </div>
            
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Description</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Montant</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Catégorie</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        <tr x-show="isLoadingTransactions">
                            <td colspan="6" class="px-6 py-4 text-center text-gray-500">
                                <i class="fas fa-spinner fa-spin mr-2"></i>Chargement des transactions...
                            </td>
                        </tr>
                        <template x-for="transaction in filteredTransactions" :key="transaction.id">
                            <tr class="hover:bg-gray-50">
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="formatDate(transaction.date || transaction.created_at || transaction.expense_date || transaction.entry_date)"></td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" x-text="transaction.description || transaction.source || '-' "></td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full"
                                          :class="{
                                              'bg-green-100 text-green-800': transaction.type === 'income',
                                              'bg-red-100 text-red-800': transaction.type === 'expense'
                                          }"
                                          x-text="transaction.type === 'income' ? 'Revenu' : 'Dépense'">
                                    </span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium"
                                    :class="{
                                        'text-green-600': transaction.type === 'income',
                                        'text-red-600': transaction.type === 'expense'
                                    }">
                                    <span x-text="(transaction.type === 'income' ? '+' : '-') + (window.formatCurrency ? window.formatCurrency(Number(transaction.amount||0)) : (Number(transaction.amount||0).toFixed(2) + ' ' + (window.AppConfig?.currentCurrency || 'MRU')))"></span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="transaction.category"></td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                    <button @click="editTransaction(transaction)" class="text-blue-600 hover:text-blue-900 mr-3">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button @click="deleteTransaction(transaction)" class="text-red-600 hover:text-red-900">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        </template>
                        
                        <tr x-show="filteredTransactions.length === 0">
                            <td colspan="6" class="px-6 py-4 text-center text-gray-500">
                                <div class="flex flex-col items-center">
                                    <i class="fas fa-receipt text-4xl text-gray-300 mb-2"></i>
                                    <p>Aucune transaction trouvée</p>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

    <!-- Transaction Modal -->
        <div x-show="showTransactionModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50" x-cloak>
            <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-1/2 shadow-lg rounded-md bg-white">
                <div class="mt-3">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-medium text-gray-900">Nouvelle Transaction</h3>
                        <button @click="showTransactionModal = false" class="text-gray-400 hover:text-gray-600">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    
                    <form @submit.prevent="createTransaction()">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Type</label>
                                <select x-model="newTransaction.type" class="w-full border border-gray-300 rounded-md px-3 py-2" required>
                                    <option value="income">Revenu</option>
                                    <option value="expense">Dépense</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Montant ({{ current_currency }})</label>
                                <input type="number" x-model="newTransaction.amount" step="0.01" min="0" class="w-full border border-gray-300 rounded-md px-3 py-2" required>
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                            <input type="text" x-model="newTransaction.description" class="w-full border border-gray-300 rounded-md px-3 py-2" required>
                        </div>
                        
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Catégorie</label>
                            <select x-model="newTransaction.category" class="w-full border border-gray-300 rounded-md px-3 py-2" required>
                                <option value="">Sélectionner une catégorie</option>
                                <template x-for="category in categories" :key="category">
                                    <option :value="category" x-text="category"></option>
                                </template>
                            </select>
                        </div>
                        
                        <div class="flex justify-end space-x-3">
                            <button type="button" @click="showTransactionModal = false" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded-md">
                                Annuler
                            </button>
                            <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md">
                                Créer Transaction
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Edit Transaction Modal -->
        <div x-show="showEditModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50" x-cloak>
            <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-1/2 shadow-lg rounded-md bg-white">
                <div class="mt-3">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-medium text-gray-900">Modifier Transaction</h3>
                        <button @click="showEditModal = false" class="text-gray-400 hover:text-gray-600">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <form @submit.prevent="updateTransaction()">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Type</label>
                                <input type="text" x-model="editData.type" class="w-full border border-gray-300 rounded-md px-3 py-2 bg-gray-100" disabled>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Montant ({{ current_currency }})</label>
                                <input type="number" x-model.number="editData.amount" step="0.01" min="0" class="w-full border border-gray-300 rounded-md px-3 py-2" required>
                            </div>
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                            <input type="text" x-model="editData.description" class="w-full border border-gray-300 rounded-md px-3 py-2">
                        </div>
                        <div class="mb-4" x-show="editData.type === 'expense'">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Catégorie</label>
                            <select x-model="editData.category" class="w-full border border-gray-300 rounded-md px-3 py-2">
                                <option value="">Sélectionner une catégorie</option>
                                <template x-for="category in categories" :key="category">
                                    <option :value="category" x-text="category"></option>
                                </template>
                            </select>
                        </div>
                        <div class="flex justify-end space-x-3">
                            <button type="button" @click="showEditModal = false" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded-md">
                                Annuler
                            </button>
                            <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md">
                                Enregistrer
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    <!-- Toasts (inside same Alpine scope) -->
    <div class="fixed top-4 right-4 space-y-2 z-[60]">
        <template x-for="t in toasts" :key="t.id">
            <div class="px-4 py-3 rounded shadow text-white"
                 :class="{'bg-green-600': t.type==='success', 'bg-red-600': t.type==='error', 'bg-yellow-600': t.type==='warning'}">
                <div class="flex items-center">
                    <i class="fas mr-2" :class="{
                        'fa-check-circle': t.type==='success',
                        'fa-exclamation-triangle': t.type==='warning',
                        'fa-times-circle': t.type==='error'
                    }"></i>
                    <span x-text="t.message"></span>
                </div>
            </div>
        </template>
    </div>
    </main>
{% endblock %}

{% block extra_scripts %}
    <script>
    function financeManager() {
            return {
        activeTab: 'summary',
                summary: {
                    total_revenue: '0 ' + (window.AppConfig?.currentCurrency || 'MRU'),
                    total_expenses: '0 ' + (window.AppConfig?.currentCurrency || 'MRU'),
                    net_profit: '0 ' + (window.AppConfig?.currentCurrency || 'MRU'),
                    cash_balance: '0 ' + (window.AppConfig?.currentCurrency || 'MRU')
                },
                transactions: [],
        receivables: [],
        receivablesTotal: 0,
                // Used as expense subcategories; backend categories are 'business'|'personal'
                categories: ['Achats', 'Salaires', 'Loyer', 'Électricité', 'Maintenance', 'Marketing', 'Divers'],
                showTransactionModal: false,
                showEditModal: false,
                newTransaction: {
                    type: 'income',
                    amount: '',
                    description: '',
                    category: ''
                },
                editData: { id: null, type: 'income', amount: 0, description: '', category: '' },
                searchTerm: '',
                filterType: '',
                chartPeriod: 'all',
                revenueChart: null,
                expenseChart: null,
                isLoadingSummary: true,
                isLoadingTransactions: true,
                isLoadingCharts: true,
                toasts: [],
                // Helpers
                parseDateFlex(s) {
                    if (!s) return null;
                    // Native parse first (handles ISO like 2025-08-09 or 2025-08-09T12:00:00Z)
                    let d = new Date(s);
                    if (!isNaN(d)) return d;
                    // Try "YYYY-MM-DD HH:MM:SS" by slicing date part
                    if (typeof s === 'string' && /^\d{4}-\d{2}-\d{2}\s+\d{2}:\d{2}/.test(s)) {
                        const part = s.slice(0, 10);
                        const d3 = new Date(part);
                        if (!isNaN(d3)) return d3;
                    }
                    // Try DD/MM/YYYY or DD-MM-YYYY
                    const m = /^([0-3]?\d)[\/\-]([0-1]?\d)[\/\-](\d{2,4})/.exec(String(s));
                    if (m) {
                        const dd = parseInt(m[1], 10), mm = parseInt(m[2], 10) - 1, yy = parseInt(m[3].length === 2 ? ('20' + m[3]) : m[3], 10);
                        const d2 = new Date(yy, mm, dd);
                        return isNaN(d2) ? null : d2;
                    }
                    return null;
                },
                toYMD(d) { return d ? d.toISOString().split('T')[0] : ''; },
                setTab(tab) {
                    this.activeTab = tab;
                    try {
                        const u = new URL(window.location);
                        if (tab === 'receivables') {
                            u.searchParams.set('tab', 'receivables');
                            u.searchParams.set('filter', 'overdue');
                            this.loadReceivables(true);
                        } else {
                            // default summary view
                            u.searchParams.delete('tab');
                            u.searchParams.delete('filter');
                        }
                        window.history.replaceState(null, '', u.toString());
                    } catch (e) { /* no-op */ }
                },
                
                init() {
                    // Route-based tab handling (e.g., ?tab=receivables&filter=overdue)
                    const params = new URLSearchParams(window.location.search);
                    const tab = params.get('tab');
                    const filter = params.get('filter');
                    const period = params.get('period');
                    if (period && ['week','month','year','all'].includes(period)) {
                        this.chartPeriod = period;
                    }
                    if (tab === 'receivables') {
                        this.activeTab = 'receivables';
                        this.loadReceivables(filter === 'overdue');
                    }

                    this.loadData();
            this.$nextTick(() => {
                        if (window.Chart) {
                this.initCharts();
                        } else {
                            const s = document.createElement('script');
                            s.src = 'https://cdn.jsdelivr.net/npm/chart.js';
                s.onload = () => this.initCharts();
                            document.head.appendChild(s);
                        }
                    });
                },
                loadReceivables(onlyOverdue=false) {
                    const url = onlyOverdue ? '/api/finance/client-debts?status=pending&overdue=true' : '/api/finance/client-debts?status=pending';
                    apiFetch(url)
                        .then(data => {
                            if (data?.success) {
                                this.receivables = data.debts || [];
                                this.receivablesTotal = Number(data.total_remaining || 0);
                            } else if (data && Array.isArray(data)) {
                                this.receivables = data;
                                this.receivablesTotal = this.receivables.reduce((s, d) => s + Number(d.remaining_amount||0), 0);
                            }
                        })
                        .catch(err => console.error('Error loading receivables', err));
                },
                
                loadData() {
                    // Load financial summary
                        this.isLoadingSummary = true; // Load financial summary (use blueprint numeric endpoint)
                        apiFetch('/api/finance/financial-summary')
                        .then(data => {
                            const cur = (window.AppConfig?.currentCurrency || 'MRU');
                            const formatCur = (v) => window.formatCurrency ? window.formatCurrency(Number(v||0)) : (Number(v||0).toFixed(2) + ' ' + cur);
                            const fs = data?.summary || data?.financial_summary || data;
                            if (fs && (fs.total_revenue !== undefined || fs.current_cash_balance !== undefined || fs.total_business_expenses !== undefined || fs.total_expenses !== undefined)) {
                                const totalExp = fs.total_expenses !== undefined
                                    ? Number(fs.total_expenses || 0)
                                    : (Number(fs.total_business_expenses||0) + Number(fs.total_personal_expenses||0));
                                const net = fs.net_profit !== undefined
                                    ? Number(fs.net_profit || 0)
                                    : (Number(fs.total_profit || fs.total_revenue || 0) - totalExp);
                                this.summary = {
                                    total_revenue: formatCur(fs.total_revenue || 0),
                                    total_expenses: formatCur(totalExp),
                                    net_profit: formatCur(net),
                                    cash_balance: formatCur(fs.current_cash_balance || fs.cash_balance || 0)
                                };
                            } else if (data && (data.success === false)) {
                                this.showToast('error', data.message || 'Erreur de chargement du résumé');
                            }
                            this.isLoadingSummary = false;
                        })
                        .catch(error => { console.error('Error loading summary:', error); this.isLoadingSummary = false; this.showToast('error', 'Erreur de chargement du résumé'); });
                    
                    // Load transactions history using unified endpoint
                    this.isLoadingTransactions = true;
                    apiFetch('/api/finance/transactions')
                    .then(data => {
                        const list = data?.transactions || (Array.isArray(data) ? data : []);
                        this.transactions = list.map(t => ({
                            id: t.id,
                            date: t.date || t.entry_date || t.expense_date || t.sale_date,
                            amount: t.amount,
                            description: t.description || t.source || t.details || '',
                            type: t.type || (t.category === 'income' ? 'income' : 'expense'),
                            category: t.category || ''
                        })).sort((a,b)=> {
                            const db = this.parseDateFlex(b.date || b.created_at);
                            const da = this.parseDateFlex(a.date || a.created_at);
                            const nb = db ? db.getTime() : 0;
                            const na = da ? da.getTime() : 0;
                            return nb - na;
                        });
                        this.isLoadingTransactions = false;
                    })
                    .catch(error => { console.error('Error loading transactions:', error); this.isLoadingTransactions = false; this.showToast('error', 'Erreur de chargement des transactions'); });
                },
                
                get filteredTransactions() {
                    return this.transactions.filter(transaction => {
                        const term = (this.searchTerm || '').toLowerCase();
                        const desc = (transaction.description || transaction.source || '').toLowerCase();
                        const matchesSearch = !term || desc.includes(term);
                        const matchesType = !this.filterType || transaction.type === this.filterType;
                        return matchesSearch && matchesType;
                    });
                },
                
                initCharts() {
                    const rev = document.getElementById('revenueChart');
                    const exp = document.getElementById('expenseChart');
                    if (!rev || !exp || !window.Chart) return;
                    const revenueCtx = rev.getContext('2d');
                    const expenseCtx = exp.getContext('2d');

                    this.revenueChart = new Chart(revenueCtx, {
                        type: 'line',
                        data: { labels: [], datasets: [{ label: `Revenus (${window.AppConfig?.currentCurrency || 'MRU'})`, data: [], borderColor: 'rgb(59, 130, 246)', backgroundColor: 'rgba(59, 130, 246, 0.1)', tension: 0.4 }] },
                        options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
                    });

                    this.expenseChart = new Chart(expenseCtx, {
                        type: 'doughnut',
                        data: { labels: [], datasets: [{ data: [], backgroundColor: ['rgb(239, 68, 68)','rgb(245, 158, 11)','rgb(34, 197, 94)','rgb(168, 85, 247)','rgb(107, 114, 128)'] }] },
                        options: { responsive: true, maintainAspectRatio: false }
                    });

                    // Load chart data initially using selected period (including 'all')
                    this.updateCharts();
                },
                
                updateCharts() {
                    this.isLoadingCharts = true;
                    // Persist selected period in URL (no reload)
                    try {
                        const u = new URL(window.location);
                        u.searchParams.set('period', this.chartPeriod);
                        window.history.replaceState(null, '', u.toString());
                    } catch (e) { /* no-op */ }
                    const periodParam = this.chartPeriod === 'all' ? 'year' : this.chartPeriod;
                    apiFetch(`/api/finance/charts?period=${periodParam}`)
                        .then(data => {
                            const chart = data?.chart_data || data || {};
                            const rev = chart.revenue || {};
                            this.revenueChart.data.labels = (rev.labels || []);
                            this.revenueChart.data.datasets[0].data = (rev.data || []).map(v => Number(v || 0));
                            this.revenueChart.update();
                            const exp = chart.expense || {};
                            this.expenseChart.data.labels = (exp.categories || []);
                            this.expenseChart.data.datasets[0].data = (exp.data || []).map(v => Number(v || 0));
                            this.expenseChart.update();
                        })
                        .catch(err => { console.error('Error updating charts:', err); })
                        .finally(() => { this.isLoadingCharts = false; });
                },
                
                createTransaction() {
                    const today = new Date().toISOString().split('T')[0];
                    const isIncome = this.newTransaction.type === 'income';
                    const url = isIncome ? '/api/finance/capital' : '/api/finance/expenses';

                    const payload = isIncome ? {
                        amount: this.newTransaction.amount,
                        source: this.newTransaction.description,
                        entry_date: today
                    } : {
                        amount: this.newTransaction.amount,
                        // Map UI category to backend schema
                        category: 'business',
                        subcategory: this.newTransaction.category || 'Divers',
                        description: this.newTransaction.description,
                        expense_date: today
                    };

                    apiFetch(url, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(payload)
                    })
                        .then(data => {
                            if (data.success) {
                                this.loadData();
                                this.showTransactionModal = false;
                                this.newTransaction = {type: 'income', amount: '', description: '', category: ''};
                                this.showToast('success', 'Transaction créée avec succès');
                            } else {
                                this.showToast('error', data.message || 'Erreur lors de la création');
                            }
                        })
                        .catch(err => { console.error('Error creating transaction:', err); this.showToast('error', 'Erreur lors de la création'); });
                },
                
                editTransaction(transaction) {
                    this.editData = {
                        id: transaction.id,
                        type: transaction.type,
                        amount: Number(transaction.amount || 0),
                        description: transaction.description || '',
                        category: transaction.category || ''
                    };
                    this.showEditModal = true;
                },

                updateTransaction() {
                    if (!this.editData.id) return;
                    const isIncome = this.editData.type === 'income';
                    const url = isIncome ? `/api/finance/capital/${this.editData.id}` : `/api/finance/expenses/${this.editData.id}`;
                    const body = isIncome
                        ? { amount: Number(this.editData.amount || 0) }
                        : { amount: Number(this.editData.amount || 0) };
                    apiFetch(url, {
                        method: 'PUT',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(body)
                    })
                    .then(data=>{
                        if (data.success) {
                            this.showEditModal = false;
                            this.loadData();
                            this.showToast('success', 'Transaction mise à jour');
                        } else {
                            this.showToast('error', data.message || 'Erreur lors de la mise à jour');
                        }
                    })
                    .catch(err=>{ console.error('Error updating transaction:', err); this.showToast('error', 'Erreur lors de la mise à jour'); });
                },
                
                deleteTransaction(transaction) {
                    if (!confirm('Êtes-vous sûr de vouloir supprimer cette transaction?')) return;

                    const url = transaction.type === 'income'
                        ? `/api/finance/capital/${transaction.id}`
                        : `/api/finance/expenses/${transaction.id}`;

                    apiFetch(url, { method: 'DELETE' })
                        .then(data => {
                            if (data.success) {
                                this.transactions = this.transactions.filter(t => t.id !== transaction.id);
                                this.showToast('success', 'Transaction supprimée');
                            } else {
                                this.showToast('error', data.message || 'Erreur lors de la suppression');
                            }
                        })
                        .catch(err => { console.error('Error deleting transaction:', err); this.showToast('error', 'Erreur lors de la suppression'); });
                },
                
                generateFinanceReport() {
                    // Respect current chart period for report time window
                    const params = new URLSearchParams();
                    const now = Date.now();
                    if (this.chartPeriod === 'week') {
                        params.append('start_date', new Date(now - 7*24*60*60*1000).toISOString().split('T')[0]);
                    } else if (this.chartPeriod === 'month') {
                        params.append('start_date', new Date(now - 30*24*60*60*1000).toISOString().split('T')[0]);
                    } else if (this.chartPeriod === 'year') {
                        params.append('start_date', new Date(now - 365*24*60*60*1000).toISOString().split('T')[0]);
                    }
                    window.open(`/api/reports/financial-report?${params.toString()}`, '_blank');
                },
                
                backupData() {
                    // Requires admin; backend will enforce permissions
                    apiFetch('/api/admin/backups', { method: 'POST' })
                        .then(data => {
                            if (data.success) {
                                this.showToast('success', 'Sauvegarde créée avec succès');
                            } else {
                                this.showToast('error', data.message || 'Échec de la sauvegarde (droits admin requis)');
                            }
                        })
                        .catch(err => { console.error('Backup error:', err); this.showToast('error', 'Erreur lors de la sauvegarde'); });
                },
                
                formatDate(dateString) {
                    if (!dateString) return '-';
                    const d = this.parseDateFlex(dateString);
                    if (!d || isNaN(d.getTime())) return '-';
                    try {
                        return d.toLocaleDateString('fr-FR');
                    } catch (e) {
                        return this.toYMD(d);
                    }
                },
                showToast(type, message) {
                    const id = Date.now() + Math.random();
                    this.toasts.push({ id, type, message });
                    setTimeout(() => {
                        this.toasts = this.toasts.filter(t => t.id !== id);
                    }, 3000);
                }
            }
        }
        
        function changeLanguage(lang) {
            window.location.href = `/set-language/${lang}`;
        }
    </script>
    <style>
        [x-cloak] { display: none !important; }
    </style>
{% endblock %}
