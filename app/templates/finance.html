{% extends "base.html" %}
{% block title_key %}finance_page_title{% endblock %}
{% block title %}Finance - SME Management{% endblock %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    .chart-container {
        position: relative;
        height: 300px;
        margin: 1rem 0;
    }
    
    .metric-card {
        transition: all 0.3s ease;
    }
    
    .metric-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    }
    
    @media (max-width: 768px) {
        .chart-container {
            height: 250px;
        }
    }
</style>
{% endblock %}

{% block content %}
<main class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8" x-data="financeManager()">
    <!-- Page Header -->
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900" data-i18n="finance_header">Gestion Financière</h1>
        <p class="text-gray-600 mt-2" data-i18n="finance_description">Suivez vos revenus, dépenses et performance financière</p>
    </div>

    <!-- Financial Summary Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <div class="metric-card bg-white rounded-lg shadow p-6">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <i class="fas fa-chart-line text-2xl text-green-600"></i>
                </div>
                <div class="ml-4">
                    <h3 class="text-sm font-medium text-gray-500">Revenus Total</h3>
                    <p class="text-2xl font-bold text-gray-900" x-text="formatCurrency(summary.total_revenue)">0</p>
                </div>
            </div>
        </div>

        <div class="metric-card bg-white rounded-lg shadow p-6">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <i class="fas fa-arrow-down text-2xl text-red-600"></i>
                </div>
                <div class="ml-4">
                    <h3 class="text-sm font-medium text-gray-500">Dépenses Total</h3>
                    <p class="text-2xl font-bold text-gray-900" x-text="formatCurrency(summary.total_business_expenses)">0</p>
                </div>
            </div>
        </div>

        <div class="metric-card bg-white rounded-lg shadow p-6">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <i class="fas fa-coins text-2xl text-blue-600"></i>
                </div>
                <div class="ml-4">
                    <h3 class="text-sm font-medium text-gray-500">Bénéfice Net</h3>
                    <p class="text-2xl font-bold" 
                       :class="summary.net_income >= 0 ? 'text-green-600' : 'text-red-600'"
                       x-text="formatCurrency(summary.net_income)">0</p>
                </div>
            </div>
        </div>

        <div class="metric-card bg-white rounded-lg shadow p-6">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <i class="fas fa-wallet text-2xl text-purple-600"></i>
                </div>
                <div class="ml-4">
                    <h3 class="text-sm font-medium text-gray-500">Solde Caisse</h3>
                    <p class="text-2xl font-bold text-gray-900" x-text="formatCurrency(summary.current_cash_balance)">0</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Tab Navigation -->
    <div class="bg-white rounded-lg shadow mb-8">
        <div class="border-b border-gray-200">
            <nav class="-mb-px flex space-x-8 px-6">
                <button @click="activeTab = 'summary'" 
                        :class="activeTab === 'summary' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                        class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                    <i class="fas fa-chart-pie mr-2"></i><span data-i18n="finance_tab_summary">Résumé</span>
                </button>
                <button @click="activeTab = 'receivables'" 
                        :class="activeTab === 'receivables' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                        class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                    <i class="fas fa-clock mr-2"></i><span data-i18n="finance_tab_receivables">Créances</span>
                </button>
                <button @click="activeTab = 'charts'" 
                        :class="activeTab === 'charts' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                        class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                    <i class="fas fa-chart-bar mr-2"></i>Graphiques
                </button>
            </nav>
        </div>
    </div>

    <!-- Summary Tab -->
    <div x-show="activeTab === 'summary'" class="space-y-6">
        <!-- Recent Transactions -->
        <div class="bg-white rounded-lg shadow">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-medium text-gray-900">Transactions Récentes</h3>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Description</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Montant</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        <template x-for="transaction in recentTransactions" :key="transaction.id">
                            <tr class="hover:bg-gray-50">
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" x-text="formatDate(transaction.date)"></td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full"
                                          :class="transaction.type === 'income' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'"
                                          x-text="transaction.type === 'income' ? 'Revenus' : 'Dépenses'">
                                    </span>
                                </td>
                                <td class="px-6 py-4 text-sm text-gray-900" x-text="transaction.description"></td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium"
                                    :class="transaction.type === 'income' ? 'text-green-600' : 'text-red-600'"
                                    x-text="formatCurrency(transaction.amount)"></td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Receivables Tab -->
    <div x-show="activeTab === 'receivables'" class="space-y-6">
        <div class="bg-white rounded-lg shadow">
            <div class="px-6 py-4 border-b border-gray-200">
                <div class="flex justify-between items-center">
                    <h3 class="text-lg font-medium text-gray-900" data-i18n="finance_tab_receivables">Créances en retard</h3>
                    <div class="flex space-x-2">
                        <select x-model="receivablesFilter" @change="loadReceivables()" class="border border-gray-300 rounded-md px-3 py-2 text-sm">
                            <option value="overdue">En retard</option>
                            <option value="pending">En attente</option>
                            <option value="all">Toutes</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Client</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Montant</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date échéance</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Jours retard</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        <template x-for="debt in receivables" :key="debt.id">
                            <tr class="hover:bg-gray-50">
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900" x-text="debt.client_name"></td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" x-text="formatCurrency(debt.remaining_amount)"></td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="formatDate(debt.due_date)"></td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full"
                                          :class="debt.days_overdue > 30 ? 'bg-red-100 text-red-800' : debt.days_overdue > 7 ? 'bg-yellow-100 text-yellow-800' : 'bg-green-100 text-green-800'"
                                          x-text="debt.days_overdue + ' jours'">
                                    </span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                    <button @click="markPaid(debt)" class="text-green-600 hover:text-green-900">
                                        <i class="fas fa-check-circle"></i> Marquer payé
                                    </button>
                                </td>
                            </tr>
                        </template>
                        
                        <tr x-show="receivables.length === 0">
                            <td colspan="5" class="px-6 py-4 text-center text-gray-500">
                                Aucune créance trouvée
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Charts Tab -->
    <div x-show="activeTab === 'charts'" class="space-y-6">
        <!-- Chart Controls -->
        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-medium text-gray-900">Analyse Financière</h3>
                <div class="flex space-x-2">
                    <button @click="updateCharts('week')" 
                            :class="chartPeriod === 'week' ? 'bg-blue-100 text-blue-600' : 'bg-gray-100 text-gray-600'"
                            class="px-3 py-1 text-xs rounded-md hover:bg-blue-200 transition">
                        7 jours
                    </button>
                    <button @click="updateCharts('month')" 
                            :class="chartPeriod === 'month' ? 'bg-blue-100 text-blue-600' : 'bg-gray-100 text-gray-600'"
                            class="px-3 py-1 text-xs rounded-md hover:bg-blue-200 transition">
                        30 jours
                    </button>
                    <button @click="updateCharts('year')" 
                            :class="chartPeriod === 'year' ? 'bg-blue-100 text-blue-600' : 'bg-gray-100 text-gray-600'"
                            class="px-3 py-1 text-xs rounded-md hover:bg-blue-200 transition">
                        1 an
                    </button>
                </div>
            </div>
            
            <!-- Revenue vs Expenses Chart -->
            <div class="chart-container">
                <canvas id="financeChart"></canvas>
            </div>
        </div>

        <!-- Profit Trend Chart -->
        <div class="bg-white rounded-lg shadow p-6">
            <h3 class="text-lg font-medium text-gray-900 mb-4">Tendance des Bénéfices</h3>
            <div class="chart-container">
                <canvas id="profitChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="flex flex-wrap gap-4 mb-6">
        <button @click="showTransactionModal = true" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg flex items-center">
            <i class="fas fa-plus mr-2"></i>
            <span data-i18n="finance_new_transaction">Nouvelle Transaction</span>
        </button>
        <button @click="showExpenseModal = true" class="bg-red-600 hover:bg-red-700 text-white px-6 py-2 rounded-lg flex items-center">
            <i class="fas fa-minus mr-2"></i>
            <span data-i18n="finance_new_expense">Nouvelle Dépense</span>
        </button>
        <button @click="generateReport()" class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-2 rounded-lg flex items-center">
            <i class="fas fa-file-alt mr-2"></i>
            <span data-i18n="finance_report">Rapport Financier</span>
        </button>
        <button @click="createBackup()" class="bg-gray-600 hover:bg-gray-700 text-white px-6 py-2 rounded-lg flex items-center">
            <i class="fas fa-save mr-2"></i>
            <span data-i18n="finance_backup">Sauvegarde</span>
        </button>
        <button @click="diagnoseCharts()" class="bg-yellow-600 hover:bg-yellow-700 text-white px-6 py-2 rounded-lg flex items-center">
            <i class="fas fa-bug mr-2"></i>
            <span data-i18n="finance_diagnose_charts">Diagnostiquer Graphiques</span>
        </button>
    </div>

    <!-- Transaction Modal -->
    <div x-show="showTransactionModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50" x-cloak>
        <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-1/2 shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-medium text-gray-900">Nouvelle Transaction</h3>
                    <button @click="showTransactionModal = false" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <form @submit.prevent="createTransaction()">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Type</label>
                            <select x-model="newTransaction.type" class="w-full border border-gray-300 rounded-md px-3 py-2" required>
                                <option value="capital">Injection de Capital</option>
                                <option value="revenue">Revenus</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Montant</label>
                            <input type="number" x-model="newTransaction.amount" step="0.01" min="0" class="w-full border border-gray-300 rounded-md px-3 py-2" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Source/Description</label>
                            <input type="text" x-model="newTransaction.source" class="w-full border border-gray-300 rounded-md px-3 py-2" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Date</label>
                            <input type="date" x-model="newTransaction.date" class="w-full border border-gray-300 rounded-md px-3 py-2" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Justification</label>
                            <textarea x-model="newTransaction.justification" class="w-full border border-gray-300 rounded-md px-3 py-2" rows="3"></textarea>
                        </div>
                    </div>
                    
                    <div class="flex justify-end space-x-3 mt-6">
                        <button type="button" @click="showTransactionModal = false" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded-md">
                            Annuler
                        </button>
                        <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md">
                            Enregistrer
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Expense Modal -->
    <div x-show="showExpenseModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50" x-cloak>
        <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-1/2 shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-medium text-gray-900">Nouvelle Dépense</h3>
                    <button @click="showExpenseModal = false" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <form @submit.prevent="createExpense()">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Catégorie</label>
                            <select x-model="newExpense.category" class="w-full border border-gray-300 rounded-md px-3 py-2" required>
                                <option value="business">Professionnel</option>
                                <option value="personal">Personnel</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Sous-catégorie</label>
                            <input type="text" x-model="newExpense.subcategory" class="w-full border border-gray-300 rounded-md px-3 py-2" placeholder="Ex: Loyer, Électricité, Fournitures">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Montant</label>
                            <input type="number" x-model="newExpense.amount" step="0.01" min="0" class="w-full border border-gray-300 rounded-md px-3 py-2" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                            <input type="text" x-model="newExpense.description" class="w-full border border-gray-300 rounded-md px-3 py-2" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Date</label>
                            <input type="date" x-model="newExpense.expense_date" class="w-full border border-gray-300 rounded-md px-3 py-2" required>
                        </div>
                    </div>
                    
                    <div class="flex justify-end space-x-3 mt-6">
                        <button type="button" @click="showExpenseModal = false" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded-md">
                            Annuler
                        </button>
                        <button type="submit" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-md">
                            Enregistrer
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</main>
{% endblock %}

{% block extra_scripts %}
<script>
function financeManager() {
    return {
        activeTab: 'summary',
        chartPeriod: 'week',
        summary: {
            total_revenue: 0,
            total_business_expenses: 0,
            total_profit: 0,
            net_income: 0,
            current_cash_balance: 0
        },
        recentTransactions: [],
        receivables: [],
        receivablesFilter: 'overdue',
        showTransactionModal: false,
        showExpenseModal: false,
        newTransaction: {
            type: 'capital',
            amount: '',
            source: '',
            date: new Date().toISOString().split('T')[0],
            justification: ''
        },
        newExpense: {
            category: 'business',
            subcategory: '',
            amount: '',
            description: '',
            expense_date: new Date().toISOString().split('T')[0]
        },
        financeChart: null,
        profitChart: null,
        
        init() {
            this.loadFinancialSummary();
            this.loadRecentTransactions();
            this.loadReceivables();
            this.$nextTick(() => {
                this.initializeCharts();
            });
        },
        
        async loadFinancialSummary() {
            try {
                const response = await apiFetch('/api/finance/financial-summary');
                if (response.success) {
                    this.summary = response.financial_summary;
                    // Calculate net income
                    this.summary.net_income = this.summary.total_profit - this.summary.total_business_expenses;
                }
            } catch (error) {
                console.error('Error loading financial summary:', error);
            }
        },
        
        async loadRecentTransactions() {
            try {
                const response = await apiFetch('/api/finance/transactions?limit=10');
                if (response.success) {
                    this.recentTransactions = response.transactions || [];
                }
            } catch (error) {
                console.error('Error loading transactions:', error);
            }
        },
        
        async loadReceivables() {
            try {
                const url = this.receivablesFilter === 'overdue' 
                    ? '/api/finance/client-debts?overdue=true'
                    : `/api/finance/client-debts?status=${this.receivablesFilter === 'all' ? 'pending' : this.receivablesFilter}`;
                const response = await apiFetch(url);
                if (response.success) {
                    this.receivables = response.debts || [];
                }
            } catch (error) {
                console.error('Error loading receivables:', error);
            }
        },
        
        async initializeCharts() {
            if (typeof Chart === 'undefined') {
                console.warn('Chart.js not available');
                return;
            }
            
            // Initialize finance chart
            const financeCtx = document.getElementById('financeChart');
            if (financeCtx) {
                this.financeChart = new Chart(financeCtx, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [
                            {
                                label: 'Revenus',
                                data: [],
                                borderColor: 'rgb(34, 197, 94)',
                                backgroundColor: 'rgba(34, 197, 94, 0.1)',
                                tension: 0.4,
                                fill: true
                            },
                            {
                                label: 'Dépenses',
                                data: [],
                                borderColor: 'rgb(239, 68, 68)',
                                backgroundColor: 'rgba(239, 68, 68, 0.1)',
                                tension: 0.4,
                                fill: true
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return window.formatCurrency ? window.formatCurrency(value) : value;
                                    }
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                position: 'top'
                            }
                        }
                    }
                });
            }
            
            // Initialize profit chart
            const profitCtx = document.getElementById('profitChart');
            if (profitCtx) {
                this.profitChart = new Chart(profitCtx, {
                    type: 'bar',
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'Bénéfice Net',
                            data: [],
                            backgroundColor: function(context) {
                                const value = context.parsed.y;
                                return value >= 0 ? 'rgba(34, 197, 94, 0.8)' : 'rgba(239, 68, 68, 0.8)';
                            },
                            borderColor: function(context) {
                                const value = context.parsed.y;
                                return value >= 0 ? 'rgb(34, 197, 94)' : 'rgb(239, 68, 68)';
                            },
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return window.formatCurrency ? window.formatCurrency(value) : value;
                                    }
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            }
                        }
                    }
                });
            }
            
            // Load initial chart data
            this.updateCharts('week');
        },
        
        async updateCharts(period) {
            this.chartPeriod = period;
            
            try {
                const response = await apiFetch(`/api/finance/charts?period=${period}`);
                if (response.success && response.chart_data) {
                    const chartData = response.chart_data;
                    
                    // Update finance chart
                    if (this.financeChart) {
                        this.financeChart.data.labels = chartData.labels;
                        this.financeChart.data.datasets[0].data = chartData.revenue;
                        this.financeChart.data.datasets[1].data = chartData.expense;
                        this.financeChart.update();
                    }
                    
                    // Update profit chart
                    if (this.profitChart) {
                        this.profitChart.data.labels = chartData.labels;
                        this.profitChart.data.datasets[0].data = chartData.profit;
                        this.profitChart.update();
                    }
                }
            } catch (error) {
                console.error('Error updating charts:', error);
                this.showNotification('Erreur lors de la mise à jour des graphiques', 'error');
            }
        },
        
        async createTransaction() {
            try {
                const transactionData = {
                    amount: parseFloat(this.newTransaction.amount),
                    source: this.newTransaction.source,
                    justification: this.newTransaction.justification,
                    entry_date: this.newTransaction.date
                };
                
                const response = await apiFetch('/api/finance/capital', {
                    method: 'POST',
                    body: transactionData
                });
                
                if (response.success) {
                    this.showTransactionModal = false;
                    this.newTransaction = {
                        type: 'capital',
                        amount: '',
                        source: '',
                        date: new Date().toISOString().split('T')[0],
                        justification: ''
                    };
                    this.loadFinancialSummary();
                    this.loadRecentTransactions();
                    this.showNotification('Transaction enregistrée avec succès', 'success');
                } else {
                    this.showNotification(response.message || 'Erreur lors de l\'enregistrement', 'error');
                }
            } catch (error) {
                console.error('Error creating transaction:', error);
                this.showNotification('Erreur lors de la création de la transaction', 'error');
            }
        },
        
        async createExpense() {
            try {
                const response = await apiFetch('/api/finance/expenses', {
                    method: 'POST',
                    body: this.newExpense
                });
                
                if (response.success) {
                    this.showExpenseModal = false;
                    this.newExpense = {
                        category: 'business',
                        subcategory: '',
                        amount: '',
                        description: '',
                        expense_date: new Date().toISOString().split('T')[0]
                    };
                    this.loadFinancialSummary();
                    this.loadRecentTransactions();
                    this.showNotification('Dépense enregistrée avec succès', 'success');
                } else {
                    this.showNotification(response.message || 'Erreur lors de l\'enregistrement', 'error');
                }
            } catch (error) {
                console.error('Error creating expense:', error);
                this.showNotification('Erreur lors de la création de la dépense', 'error');
            }
        },
        
        async markPaid(debt) {
            if (!confirm(`Marquer la créance de ${debt.client_name} comme payée?`)) {
                return;
            }
            
            try {
                const response = await apiFetch(`/api/finance/client-debts/${debt.id}/status`, {
                    method: 'PATCH'
                });
                
                if (response.success) {
                    this.loadReceivables();
                    this.loadFinancialSummary();
                    this.showNotification('Créance marquée comme payée', 'success');
                } else {
                    this.showNotification(response.message || 'Erreur lors de la mise à jour', 'error');
                }
            } catch (error) {
                console.error('Error marking debt as paid:', error);
                this.showNotification('Erreur lors de la mise à jour du statut', 'error');
            }
        },
        
        generateReport() {
            window.open('/api/reports/financial-report', '_blank');
        },
        
        createBackup() {
            window.open('/api/admin/backups', '_blank');
        },
        
        diagnoseCharts() {
            console.log('Chart diagnosis:');
            console.log('Finance Chart:', this.financeChart);
            console.log('Profit Chart:', this.profitChart);
            console.log('Chart.js available:', typeof Chart !== 'undefined');
            
            if (typeof Chart === 'undefined') {
                this.showNotification('Chart.js n\'est pas chargé', 'error');
            } else if (!this.financeChart || !this.profitChart) {
                this.showNotification('Graphiques non initialisés', 'warning');
                this.initializeCharts();
            } else {
                this.showNotification('Graphiques fonctionnels', 'success');
                this.updateCharts(this.chartPeriod);
            }
        },
        
        formatCurrency(amount) {
            return window.formatCurrency ? window.formatCurrency(amount) : `${amount} MRU`;
        },
        
        formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('fr-FR');
        },
        
        showNotification(message, type = 'info') {
            if (window.showNotification) {
                window.showNotification(message, type);
            } else {
                alert(message);
            }
        }
    };
}
</script>
<style>
[x-cloak] { display: none !important; }
</style>
{% endblock %}