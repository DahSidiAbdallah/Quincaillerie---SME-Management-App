{% extends 'base.html' %}

{% block title %}Administration - Quincaillerie Management{% endblock %}

{% block extra_head %}
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
<script src="{{ url_for('static', filename='js/alpine-admin-extensions.js') }}"></script>
<script src="{{ url_for('static', filename='js/alpine-realtime-patch.js') }}"></script>
<script src="{{ url_for('static', filename='js/admin-diagnostics.js') }}" defer></script>
{% endblock %}

{% block content %}
<main class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8" x-data="adminManager()" x-init="init()" x-admin-fix>
        <!-- Page Header -->
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-gray-900">Panneau d'Administration</h1>
            <p class="text-gray-600 mt-2">Gérez les utilisateurs, paramètres système et configuration</p>
        </div>

        <!-- Logs -->
        <div x-show="activeTab === 'logs'" class="space-y-4">
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-medium text-gray-900">Journaux Récents</h3>
                    <button @click="loadLogs()" class="bg-gray-100 hover:bg-gray-200 text-gray-800 px-3 py-1 rounded-md">Rafraîchir</button>
                </div>
                <div class="h-80 overflow-auto bg-gray-50 border border-gray-200 rounded p-3 font-mono text-sm whitespace-pre-wrap">
                    <template x-if="logs.entries && logs.entries.length">
                        <div>
                            <template x-for="(line, idx) in logs.entries" :key="idx">
                                <div x-text="line"></div>
                            </template>
                        </div>
                    </template>
                    <template x-if="!logs.entries || !logs.entries.length">
                        <div class="text-gray-500">Aucun journal à afficher.</div>
                    </template>
                </div>
            </div>
        </div>

        <!-- Admin Menu Tabs -->
        <div class="bg-white rounded-lg shadow mb-8">
            <div class="border-b border-gray-200">
                <nav class="-mb-px flex space-x-8 px-6">
                    <button @click="switchTab('users')" 
                            :class="activeTab === 'users' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                            class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                        <i class="fas fa-users mr-2"></i>Utilisateurs
                    </button>
                    <button @click="switchTab('settings')" 
                            :class="activeTab === 'settings' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                            class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                        <i class="fas fa-cog mr-2"></i>Paramètres
                    </button>
                    <button @click="switchTab('backup')" 
                            :class="activeTab === 'backup' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                            class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                        <i class="fas fa-database mr-2"></i>Sauvegarde
                    </button>
                    <button @click="switchTab('logs')" 
                            :class="activeTab === 'logs' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                            class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                        <i class="fas fa-list-alt mr-2"></i>Journaux
                    </button>
                    <button @click="switchTab('system')" 
                            :class="activeTab === 'system' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                            class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                        <i class="fas fa-server mr-2"></i>Système
                    </button>
                </nav>
            </div>
        </div>

        <!-- Users Management -->
        <div x-show="activeTab === 'users'" class="space-y-8">
            <div class="bg-white rounded-lg shadow">
                <div class="px-6 py-4 border-b border-gray-200">
                    <div class="flex justify-between items-center">
                        <h3 class="text-lg font-medium text-gray-900">Gestion des Utilisateurs</h3>
                        <button @click="showUserModal = true" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md flex items-center">
                            <i class="fas fa-plus mr-2"></i>
                            Nouvel Utilisateur
                        </button>
                    </div>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nom d'utilisateur</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Rôle</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Dernière connexion</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Statut</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <template x-for="user in users" :key="user.id">
                                <tr class="hover:bg-gray-50">
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="flex items-center">
                                            <div class="flex-shrink-0 h-10 w-10">
                                                <div class="h-10 w-10 rounded-full bg-blue-100 flex items-center justify-center">
                                                    <i class="fas fa-user text-blue-600"></i>
                                                </div>
                                            </div>
                                            <div class="ml-4">
                                                <div class="text-sm font-medium text-gray-900" x-text="user.username"></div>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full"
                                              :class="{
                                                  'bg-red-100 text-red-800': user.role === 'admin',
                                                  'bg-blue-100 text-blue-800': user.role === 'manager',
                                                  'bg-green-100 text-green-800': user.role === 'employee'
                                              }"
                                              x-text="user.role">
                                        </span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="user.last_login || 'Jamais'"></td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full"
                                              :class="user.is_active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'"
                                              x-text="user.is_active ? 'Actif' : 'Inactif'">
                                        </span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                        <button @click="editUser(user)" class="text-blue-600 hover:text-blue-900 mr-3">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button @click="toggleUserStatus(user)" class="text-yellow-600 hover:text-yellow-900 mr-3">
                                            <i class="fas fa-power-off"></i>
                                        </button>
                                        <button @click="deleteUser(user)" class="text-red-600 hover:text-red-900">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- System Settings -->
        <div x-show="activeTab === 'settings'" class="space-y-8">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- General Settings -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-medium text-gray-900 mb-4">Paramètres Généraux</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Nom de l'entreprise</label>
                            <input type="text" x-model="settings.store_name" class="w-full border border-gray-300 rounded-md px-3 py-2">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Langue par défaut</label>
                            <select x-model="settings.language" class="w-full border border-gray-300 rounded-md px-3 py-2">
                                <option value="fr">Français</option>
                                <option value="ar">العربية</option>
                                
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Devise</label>
                            <select x-model="settings.currency" class="w-full border border-gray-300 rounded-md px-3 py-2">
                                <option value="MRU">Ouguiyas (MRU)</option>
                                <option value="EUR">Euro (€)</option>
                                <option value="USD">Dollar ($)</option>
                            </select>
                        </div>
                        <div>
                            <label class="flex items-center">
                                <input type="checkbox" x-model="settings.email_notifications" class="rounded border-gray-300">
                                <span class="ml-2 text-sm text-gray-700">Activer les notifications</span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Security Settings -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-medium text-gray-900 mb-4">Paramètres de Sécurité</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Durée de session (minutes)</label>
                            <input type="number" x-model.number="settings.session_timeout_minutes" min="5" max="480" class="w-full border border-gray-300 rounded-md px-3 py-2">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Tentatives de connexion max</label>
                            <input type="number" x-model.number="settings.max_login_attempts" min="3" max="10" class="w-full border border-gray-300 rounded-md px-3 py-2">
                        </div>
                        <div>
                            <label class="flex items-center">
                                <input type="checkbox" x-model="settings.require_strong_passwords" class="rounded border-gray-300">
                                <span class="ml-2 text-sm text-gray-700">Exiger des mots de passe forts</span>
                            </label>
                        </div>
                        <div>
                            <label class="flex items-center">
                                <input type="checkbox" x-model="settings.audit_log_enabled" class="rounded border-gray-300">
                                <span class="ml-2 text-sm text-gray-700">Activer le journal d'audit</span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <div class="flex justify-end">
                <button @click="saveSettings()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-md">
                    <i class="fas fa-save mr-2"></i>
                    Sauvegarder les Paramètres
                </button>
            </div>
        </div>

        <!-- Backup & Restore -->
        <div x-show="activeTab === 'backup'" class="space-y-8">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-medium text-gray-900 mb-4">Sauvegarde</h3>
                    <div class="space-y-4">
                        <p class="text-gray-600">Créez une sauvegarde complète de vos données.</p>
                        <div class="flex items-center space-x-4">
                            <button @click="createBackup()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md flex items-center">
                                <i class="fas fa-download mr-2"></i>
                                Créer Sauvegarde
                            </button>
                            <button @click="scheduleBackup()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md flex items-center">
                                <i class="fas fa-clock mr-2"></i>
                                Programmer
                            </button>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-medium text-gray-900 mb-4">Restauration</h3>
                    <div class="space-y-4">
                        <p class="text-gray-600">Restaurez vos données à partir d'une sauvegarde.</p>
                        <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center" @dragover.prevent @dragenter.prevent @drop.prevent="onRestoreDrop($event)">
                            <i class="fas fa-upload text-4xl text-gray-400 mb-2"></i>
                            <p class="text-gray-500">Glissez-déposez votre fichier de sauvegarde ici</p>
                            <div class="mt-2">
                                <input type="file" id="restoreFileInput" class="hidden" accept="application/json" @change="onRestoreFileSelected($event)">
                                <button @click="triggerRestoreFile()" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-md">
                                    Sélectionner Fichier
                                </button>
                                <template x-if="restoreFileName">
                                    <div class="mt-2 text-sm text-gray-600" x-text="restoreFileName"></div>
                                </template>
                            </div>
                            <template x-if="isRestoring">
                                <div class="mt-3 text-blue-600 text-sm">Restauration en cours...</div>
                            </template>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Backups -->
            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-lg font-medium text-gray-900 mb-4">Sauvegardes Récentes</h3>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Taille</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <template x-for="backup in backups" :key="backup.id">
                                <tr>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" x-text="backup.date"></td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="backup.size"></td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="backup.type"></td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                        <button @click="downloadBackup(backup)" class="text-blue-600 hover:text-blue-900 mr-3">
                                            <i class="fas fa-download"></i>
                                        </button>
                                        <button @click="deleteBackup(backup)" class="text-red-600 hover:text-red-900">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- System Info -->
        <div x-show="activeTab === 'system'" class="space-y-8">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-medium text-gray-900 mb-4">Informations Système</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between">
                            <span class="text-gray-600">Version de l'application:</span>
                            <span class="font-medium">{{ app_version }}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Python:</span>
                            <span class="font-medium" x-text="systemInfo.python_version">3.13.5</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Base de données:</span>
                            <span class="font-medium">SQLite</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Démarrage:</span>
                            <span class="font-medium" x-text="systemInfo.uptime">2h 34m</span>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-medium text-gray-900 mb-4">Performance</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between">
                            <span class="text-gray-600">Utilisation CPU:</span>
                            <span class="font-medium text-green-600">12%</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Utilisation Mémoire:</span>
                            <span class="font-medium text-blue-600">245 MB</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Espace Disque:</span>
                            <span class="font-medium text-yellow-600">2.1 GB</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Connexions actives:</span>
                            <span class="font-medium">3</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- User Modal -->
        <div x-show="showUserModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50" x-cloak>
            <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-1/2 shadow-lg rounded-md bg-white">
                <div class="mt-3">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-medium text-gray-900" x-text="editingUserId ? 'Modifier Utilisateur' : 'Nouvel Utilisateur'"></h3>
                        <button @click="showUserModal = false" class="text-gray-400 hover:text-gray-600">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    
                    <form @submit.prevent="createUser()">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Nom d'utilisateur</label>
                                <input type="text" x-model="newUser.username" class="w-full border border-gray-300 rounded-md px-3 py-2" required>
                            </div>
                            <div x-show="!editingUserId">
                                <label class="block text-sm font-medium text-gray-700 mb-2">PIN</label>
                                <input type="password" x-model="newUser.pin" class="w-full border border-gray-300 rounded-md px-3 py-2" :required="!editingUserId">
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Rôle</label>
                            <select x-model="newUser.role" class="w-full border border-gray-300 rounded-md px-3 py-2" required>
                                <option value="employee">Employé</option>
                                <option value="manager">Manager</option>
                                <option value="admin">Administrateur</option>
                            </select>
                        </div>
                        
                        <div class="flex justify-end space-x-3">
                            <button type="button" @click="showUserModal = false" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded-md">
                                Annuler
                            </button>
                            <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md" x-text="editingUserId ? 'Enregistrer' : 'Créer Utilisateur'">
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </main>

   
{% endblock %}

{% block extra_scripts %}
    <script>
        function adminManager() {
            return {
                activeTab: 'users',
                showUserModal: false,
                users: [],
                newUser: {
                    username: '',
                    pin: '',
                    role: 'employee'
                },
                editingUserId: null,
                settings: { store_name: '', language: 'fr', currency: 'MRU', email_notifications: true, session_timeout_minutes: 30, max_login_attempts: 5, audit_log_enabled: true, require_strong_passwords: false },
                backups: [],
                systemInfo: {},
                logs: {},
                isRestoring: false,
                restoreFileName: '',
                
                init() {
                    this.loadData();
                },
                
                loadData() {
                    console.log('Loading admin data...');
                    
                    // Helper function to store users in a global variable for backup access
                    const storeGlobalData = (type, data) => {
                        if (!window.__adminData) window.__adminData = {};
                        window.__adminData[type] = data;
                    };
                    
                    // Load users data
                    apiFetch('/api/auth/users')
                        .then(r => r.json())
                        .then(data => { 
                            if (data.success) { 
                                this.users = data.users || []; 
                                console.log('Users loaded:', this.users.length);
                                // Store in global backup
                                storeGlobalData('users', this.users);
                                // Dispatch event for diagnostics tool
                                document.dispatchEvent(new CustomEvent('admin-users-loaded', { detail: this.users }));
                            } else {
                                console.error('Error loading users:', data.message);
                            }
                        })
                        .catch(err => {
                            console.error('Error loading users:', err);
                            // Try to load from global backup if available
                            if (window.__adminData && window.__adminData.users) {
                                this.users = window.__adminData.users;
                                console.log('Loaded users from backup cache');
                            }
                        });

                    // Load settings data
                    apiFetch('/api/admin/settings')
                        .then(data => { 
                            if (data.success) { 
                                this.settings = Object.assign({}, this.settings, data.settings || {}); 
                                console.log('Settings loaded:', Object.keys(this.settings).length);
                                // Store in global backup
                                storeGlobalData('settings', this.settings);
                                // Dispatch event for diagnostics tool
                                document.dispatchEvent(new CustomEvent('admin-settings-loaded', { detail: this.settings }));
                            } else {
                                console.error('Error loading settings:', data.message);
                            }
                        })
                        .catch(err => {
                            console.error('Error loading settings:', err);
                            // Try to load from global backup if available
                            if (window.__adminData && window.__adminData.settings) {
                                this.settings = window.__adminData.settings;
                                console.log('Loaded settings from backup cache');
                            }
                        });

                    // Load backups data
                    apiFetch('/api/admin/backups')
                        .then(data => { 
                            if (data.success) { 
                                this.backups = data.backups || []; 
                                console.log('Backups loaded:', this.backups.length);
                                // Store in global backup
                                storeGlobalData('backups', this.backups);
                                // Dispatch event for diagnostics tool
                                document.dispatchEvent(new CustomEvent('admin-backups-loaded', { detail: this.backups }));
                            } else {
                                console.error('Error loading backups:', data.message);
                            }
                        })
                        .catch(err => {
                            console.error('Error loading backups:', err);
                            // Try to load from global backup if available
                            if (window.__adminData && window.__adminData.backups) {
                                this.backups = window.__adminData.backups;
                                console.log('Loaded backups from backup cache');
                            }
                        });
                    
                    // Preload logs when tab likely used later
                    this.loadLogs();
                },
                
                switchTab(tab) {
                    this.activeTab = tab;
                    if (tab === 'logs') {
                        this.loadLogs();
                    }
                },
                
                createUser() {
                    const isEdit = this.editingUserId !== null;
                    const payload = { username: this.newUser.username, role: this.newUser.role };
                    if (!isEdit) { payload.pin = this.newUser.pin; }
                    const url = isEdit ? `/api/auth/users/${this.editingUserId}` : '/api/auth/create-user';
                    const method = isEdit ? 'PUT' : 'POST';

                    apiFetch(url, {
                        method: method,
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(payload)
                    })
                        .then(data => {
                            if (data.success) {
                                this.loadData();
                                this.showUserModal = false;
                                this.newUser = {username: '', pin: '', role: 'employee'};
                                this.editingUserId = null;
                                alert(isEdit ? 'Utilisateur mis à jour' : 'Utilisateur créé avec succès!');
                            } else {
                                alert(data.message || 'Erreur');
                            }
                        })
                        .catch(err => console.error('Error saving user:', err));
                },

                editUser(user) {
                    this.editingUserId = user.id;
                    this.newUser = { username: user.username, pin: '', role: user.role };
                    this.showUserModal = true;
                },
                
                toggleUserStatus(user) {
                    console.log('Toggling user status for:', user.username);
                    // Save the current status to revert in case of error
                    const originalStatus = user.is_active;
                    
                    // Optimistic UI update - update UI immediately
                    user.is_active = !user.is_active;
                    
                    apiFetch(`/api/auth/users/${user.id}`, {
                        method: 'PUT',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({is_active: user.is_active})
                    })
                        .then(data => {
                            if (data.success) {
                                console.log('User status updated successfully');
                            } else {
                                // Revert the optimistic update if there was an error
                                user.is_active = originalStatus;
                                alert(data.message || 'Erreur de mise à jour');
                            }
                        })
                        .catch(err => {
                            console.error('Error updating user:', err);
                            // Revert the optimistic update on error
                            user.is_active = originalStatus;
                            alert('Erreur lors de la mise à jour. Veuillez réessayer.');
                        });
                },
                
                deleteUser(user) {
                    if (confirm(`Êtes-vous sûr de vouloir supprimer l'utilisateur ${user.username}?`)) {
                        console.log('Deleting user:', user.username);
                        
                        // Store user for potential restoration
                        const deletedUser = {...user};
                        
                        // Optimistic UI update - remove from list immediately
                        this.users = this.users.filter(u => u.id !== user.id);
                        
                apiFetch(`/api/auth/users/${user.id}`, { method: 'DELETE' })
                    .then(data => {
                                if (data.success) {
                                    console.log('User deleted successfully');
                                } else {
                                    // Restore user to the list if deletion failed
                                    this.users.push(deletedUser);
                                    alert(data.message || 'Erreur de suppression');
                                }
                            })
                            .catch(err => {
                                console.error('Error deleting user:', err);
                                // Restore user to the list on error
                                this.users.push(deletedUser);
                                alert('Erreur lors de la suppression. Veuillez réessayer.');
                            });
                    }
                },
                
                saveSettings() {
                    console.log('Saving settings:', this.settings);
                    
                    // Save a copy of the settings before saving
                    const originalSettings = JSON.parse(JSON.stringify(this.settings));
                    
                    // Show saving status
                    const statusEl = document.createElement('div');
                    statusEl.id = 'settings-save-status';
                    statusEl.textContent = 'Sauvegarde des paramètres en cours...';
                    statusEl.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #3b82f6; color: white; padding: 10px; border-radius: 5px; z-index: 9999;';
                    document.body.appendChild(statusEl);
                    
                    // Save general settings first
                    apiFetch('/api/admin/settings', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(this.settings)
                    })
                        .then(data => { 
                            if (data.success) {
                                // Then persist security-specific settings if backend supports it
                                return apiFetch('/api/admin/settings/security', {
                                    method: 'POST',
                                    headers: {'Content-Type': 'application/json'},
                                    body: JSON.stringify({
                                        session_timeout_minutes: this.settings.session_timeout_minutes,
                                        max_login_attempts: this.settings.max_login_attempts,
                                        audit_log_enabled: this.settings.audit_log_enabled,
                                        email_notifications: this.settings.email_notifications,
                                        currency: this.settings.currency
                                    })
                                }).then(sec => {
                                    if (!sec.success) throw new Error(sec.message || 'Erreur paramètres sécurité');
                                    return { success: true };
                                });
                            } else {
                                // Restore original settings on error
                                this.settings = originalSettings;
                                throw new Error(data.message || 'Erreur lors de la sauvegarde des paramètres');
                            }
                        })
                        .then(() => {
                            statusEl.textContent = 'Paramètres sauvegardés avec succès';
                            statusEl.style.background = '#10b981';
                            setTimeout(() => statusEl.remove(), 3000);
                            const feedback = document.createElement('div');
                            feedback.textContent = '✅ Paramètres sauvegardés';
                            feedback.style.cssText = 'position: fixed; bottom: 20px; left: 20px; background: #10b981; color: white; padding: 10px; border-radius: 5px; z-index: 9998;';
                            document.body.appendChild(feedback);
                            setTimeout(() => feedback.remove(), 3000);
                            console.log('Settings saved successfully');
                        })
                        .catch(err => {
                            // Restore original settings on error
                            this.settings = originalSettings;
                            
                            statusEl.textContent = 'Erreur lors de la sauvegarde des paramètres';
                            statusEl.style.background = '#ef4444';
                            setTimeout(() => statusEl.remove(), 3000);
                            
                            console.error('Error saving settings:', err);
                            alert(err.message || 'Erreur lors de la sauvegarde des paramètres');
                        });
                },
                
                loadLogs() {
                    apiFetch('/api/admin/logs')
                        .then(data => {
                            if (data.success) {
                                const entries = (data.logs && data.logs.recent) ? data.logs.recent : [];
                                this.logs = { entries };
                            } else {
                                console.error('Erreur chargement journaux:', data.message);
                            }
                        })
                        .catch(e => console.error('Erreur journaux:', e));
                },

                triggerRestoreFile() {
                    const el = document.getElementById('restoreFileInput');
                    if (el) el.click();
                },
                
                onRestoreFileSelected(evt) {
                    const file = evt.target.files && evt.target.files[0];
                    if (file) {
                        this.restoreFileName = file.name;
                        this.uploadRestoreFile(file);
                    }
                },
                
                onRestoreDrop(event) {
                    const file = event.dataTransfer && event.dataTransfer.files && event.dataTransfer.files[0];
                    if (file) {
                        this.restoreFileName = file.name;
                        this.uploadRestoreFile(file);
                    }
                },
                
                uploadRestoreFile(file) {
                    this.isRestoring = true;
                    const form = new FormData();
                    form.append('file', file);
                    apiFetch('/api/admin/backups/restore', {
                        method: 'POST',
                        body: form
                    })
                    .then(data => {
                        this.isRestoring = false;
                        if (data.success) {
                            alert('Restauration réussie');
                            // reload data
                            this.loadData();
                        } else {
                            alert(data.message || 'Erreur de restauration');
                        }
                    })
                    .catch(err => {
                        this.isRestoring = false;
                        console.error('Erreur restauration:', err);
                        alert('Erreur lors de la restauration');
                    });
                },
                
                createBackup() {
                    console.log('Creating backup...');
                    
                    // Show creating status
                    const statusEl = document.createElement('div');
                    statusEl.id = 'backup-status';
                    statusEl.textContent = 'Création de la sauvegarde en cours...';
                    statusEl.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #3b82f6; color: white; padding: 10px; border-radius: 5px; z-index: 9999;';
                    document.body.appendChild(statusEl);
                    
                    apiFetch('/api/admin/backups', {method: 'POST'})
                        .then(data => {
                            if (data.success) {
                                // Update status
                                statusEl.textContent = 'Sauvegarde créée avec succès!';
                                statusEl.style.background = '#10b981';
                                
                                // Refresh data immediately
                                this.loadData();
                                
                                // Alert user
                                setTimeout(() => alert('Sauvegarde créée avec succès!'), 500);
                                
                                // Remove status after 3 seconds
                                setTimeout(() => statusEl.remove(), 3000);
                            } else {
                                statusEl.textContent = 'Erreur: ' + (data.message || 'Erreur création sauvegarde');
                                statusEl.style.background = '#ef4444';
                                setTimeout(() => statusEl.remove(), 3000);
                                alert(data.message || 'Erreur création sauvegarde');
                            }
                        })
                        .catch(err => {
                            console.error('Error creating backup:', err);
                            statusEl.textContent = 'Erreur lors de la création de la sauvegarde';
                            statusEl.style.background = '#ef4444';
                            setTimeout(() => statusEl.remove(), 3000);
                            alert('Erreur lors de la création de la sauvegarde');
                        });
                },
                
                scheduleBackup() {
                    alert('Configuration de la sauvegarde programmée...');
                },
                
                downloadBackup(backup) {
                    window.open(`/api/admin/backups/${backup.id}`, '_blank');
                },
                
                deleteBackup(backup) {
                    if (!confirm('Êtes-vous sûr de vouloir supprimer cette sauvegarde?')) return;
                    
                    console.log('Deleting backup:', backup.id);
                    
                    // Store backup for potential restoration
                    const deletedBackup = {...backup};
                    
                    // Optimistic UI update - remove from list immediately
                    this.backups = this.backups.filter(b => b.id !== backup.id);
                    
                    // Show status notification
                    const statusEl = document.createElement('div');
                    statusEl.id = 'delete-backup-status';
                    statusEl.textContent = 'Suppression en cours...';
                    statusEl.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #3b82f6; color: white; padding: 10px; border-radius: 5px; z-index: 9999;';
                    document.body.appendChild(statusEl);
                    
                    apiFetch(`/api/admin/backups/${backup.id}`, {method: 'DELETE'})
                        .then(data => { 
                            if (data.success) { 
                                console.log('Backup deleted successfully');
                                statusEl.textContent = 'Sauvegarde supprimée avec succès';
                                statusEl.style.background = '#10b981';
                                setTimeout(() => statusEl.remove(), 3000);
                            } else { 
                                // Restore backup to the list if deletion failed
                                this.backups.push(deletedBackup);
                                statusEl.textContent = 'Erreur: ' + (data.message || 'Erreur de suppression');
                                statusEl.style.background = '#ef4444';
                                setTimeout(() => statusEl.remove(), 3000);
                                alert(data.message || 'Erreur'); 
                            } 
                        })
                        .catch(err => {
                            console.error('Error deleting backup:', err);
                            // Restore backup to the list on error
                            this.backups.push(deletedBackup);
                            statusEl.textContent = 'Erreur lors de la suppression';
                            statusEl.style.background = '#ef4444';
                            setTimeout(() => statusEl.remove(), 3000);
                            alert('Erreur lors de la suppression. Veuillez réessayer.');
                        });
                }
            }
        }
        
        function changeLanguage(lang) {
            window.location.href = `/set-language/${lang}`;
        }
    </script>
    <style>
        [x-cloak] { display: none !important; }
    </style>
{% endblock %}
