{% extends "base.html" %}

{% block title %}Paramètres - SME Management{% endblock %}

{% block extra_head %}
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
<style>
    .settings-card {
        transition: all 0.3s ease;
    }
    
    .settings-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    }
    
    .profile-photo {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        object-fit: cover;
        border: 3px solid #e5e7eb;
    }
    
    .activity-item {
        border-left: 3px solid #3b82f6;
        padding-left: 1rem;
    }
</style>
{% endblock %}

{% block content %}
<main class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8" x-data="settingsManager()">
    <!-- Page Header -->
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900">Paramètres Utilisateur</h1>
        <p class="text-gray-600 mt-2">Gérez votre profil, préférences et sécurité</p>
    </div>

    <!-- Tab Navigation -->
    <div class="bg-white rounded-lg shadow mb-8">
        <div class="border-b border-gray-200">
            <nav class="-mb-px flex space-x-8 px-6">
                <button @click="activeTab = 'profile'" 
                        :class="activeTab === 'profile' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                        class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                    <i class="fas fa-user mr-2"></i>Profil
                </button>
                <button @click="activeTab = 'preferences'" 
                        :class="activeTab === 'preferences' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                        class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                    <i class="fas fa-cog mr-2"></i>Préférences
                </button>
                <button @click="activeTab = 'security'" 
                        :class="activeTab === 'security' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                        class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                    <i class="fas fa-shield-alt mr-2"></i>Sécurité
                </button>
                <button @click="activeTab = 'notifications'" 
                        :class="activeTab === 'notifications' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                        class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                    <i class="fas fa-bell mr-2"></i>Notifications
                </button>
            </nav>
        </div>
    </div>

    <!-- Profile Tab -->
    <div x-show="activeTab === 'profile'" class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Profile Information -->
        <div class="lg:col-span-2">
            <div class="settings-card bg-white rounded-lg shadow p-6">
                <h3 class="text-lg font-medium text-gray-900 mb-6">Informations du Profil</h3>
                
                <form @submit.prevent="updateProfile()">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Prénom</label>
                            <input type="text" x-model="profile.first_name" class="w-full border border-gray-300 rounded-md px-3 py-2">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Nom</label>
                            <input type="text" x-model="profile.last_name" class="w-full border border-gray-300 rounded-md px-3 py-2">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                            <input type="email" x-model="profile.email" class="w-full border border-gray-300 rounded-md px-3 py-2">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Téléphone</label>
                            <input type="text" x-model="profile.phone" class="w-full border border-gray-300 rounded-md px-3 py-2">
                        </div>
                    </div>
                    
                    <div class="flex justify-end mt-6">
                        <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-md">
                            <i class="fas fa-save mr-2"></i>Enregistrer
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Profile Photo & Activity -->
        <div class="space-y-6">
            <!-- Profile Photo -->
            <div class="settings-card bg-white rounded-lg shadow p-6 text-center">
                <h3 class="text-lg font-medium text-gray-900 mb-4">Photo de Profil</h3>
                
                <div class="mb-4">
                    <img :src="profile.photo_url || '/static/default-user.png'" 
                         :alt="profile.first_name + ' ' + profile.last_name"
                         class="profile-photo mx-auto">
                </div>
                
                <div class="space-y-3">
                    <input type="file" id="photoInput" accept="image/*" @change="uploadPhoto($event)" class="hidden">
                    <button @click="$refs.photoInput.click()" class="w-full bg-gray-600 hover:bg-gray-700 text-white py-2 px-4 rounded-md">
                        <i class="fas fa-camera mr-2"></i>Changer la photo
                    </button>
                </div>
            </div>

            <!-- User Info -->
            <div class="settings-card bg-white rounded-lg shadow p-6">
                <h3 class="text-lg font-medium text-gray-900 mb-4">Informations Utilisateur</h3>
                
                <div class="space-y-3 text-sm">
                    <div class="flex justify-between">
                        <span class="text-gray-500">Nom d'utilisateur:</span>
                        <span class="font-medium" x-text="user.username"></span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-500">Rôle:</span>
                        <span class="px-2 py-1 text-xs font-medium rounded-full"
                              :class="{
                                  'bg-red-100 text-red-800': user.role === 'admin',
                                  'bg-blue-100 text-blue-800': user.role === 'manager',
                                  'bg-green-100 text-green-800': user.role === 'employee'
                              }"
                              x-text="user.role">
                        </span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-500">Membre depuis:</span>
                        <span x-text="user.created_at_formatted"></span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-500">Dernière connexion:</span>
                        <span x-text="user.last_login_formatted || 'Jamais'"></span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Preferences Tab -->
    <div x-show="activeTab === 'preferences'" class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <!-- Language & Display -->
        <div class="settings-card bg-white rounded-lg shadow p-6">
            <h3 class="text-lg font-medium text-gray-900 mb-6">Langue et Affichage</h3>
            
            <form @submit.prevent="updatePreferences()">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Langue</label>
                        <select x-model="preferences.language" class="w-full border border-gray-300 rounded-md px-3 py-2">
                            <option value="fr">Français</option>
                            <option value="ar">العربية</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Devise</label>
                        <select x-model="preferences.currency" class="w-full border border-gray-300 rounded-md px-3 py-2">
                            <option value="MRU">Ouguiya (MRU)</option>
                            <option value="EUR">Euro (€)</option>
                            <option value="USD">Dollar ($)</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Décimales</label>
                        <select x-model="preferences.decimal_places" class="w-full border border-gray-300 rounded-md px-3 py-2">
                            <option value="0">0 décimale</option>
                            <option value="2">2 décimales</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Thème</label>
                        <select x-model="preferences.theme" class="w-full border border-gray-300 rounded-md px-3 py-2">
                            <option value="light">Clair</option>
                            <option value="dark">Sombre</option>
                        </select>
                    </div>
                </div>
                
                <div class="flex justify-end mt-6">
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-md">
                        <i class="fas fa-save mr-2"></i>Enregistrer
                    </button>
                </div>
            </form>
        </div>

        <!-- Interface Preferences -->
        <div class="settings-card bg-white rounded-lg shadow p-6">
            <h3 class="text-lg font-medium text-gray-900 mb-6">Préférences Interface</h3>
            
            <div class="space-y-4">
                <div class="flex items-center justify-between">
                    <div>
                        <label class="text-sm font-medium text-gray-700">Sauvegarde automatique</label>
                        <p class="text-xs text-gray-500">Sauvegarder automatiquement les modifications</p>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" x-model="preferences.auto_save" class="sr-only peer">
                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                    </label>
                </div>
                
                <div class="flex items-center justify-between">
                    <div>
                        <label class="text-sm font-medium text-gray-700">Afficher les info-bulles</label>
                        <p class="text-xs text-gray-500">Afficher l'aide contextuelle</p>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" x-model="preferences.show_tooltips" class="sr-only peer">
                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                    </label>
                </div>
                
                <div class="flex items-center justify-between">
                    <div>
                        <label class="text-sm font-medium text-gray-700">Vue compacte</label>
                        <p class="text-xs text-gray-500">Réduire l'espacement des éléments</p>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" x-model="preferences.compact_view" class="sr-only peer">
                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                    </label>
                </div>
            </div>
            
            <div class="flex justify-end mt-6">
                <button @click="updatePreferences()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-md">
                    <i class="fas fa-save mr-2"></i>Enregistrer
                </button>
            </div>
        </div>
    </div>

    <!-- Security Tab -->
    <div x-show="activeTab === 'security'" class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <!-- Change PIN -->
        <div class="settings-card bg-white rounded-lg shadow p-6">
            <h3 class="text-lg font-medium text-gray-900 mb-6">Changer le PIN</h3>
            
            <form @submit.prevent="updatePin()">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">PIN actuel</label>
                        <input type="password" x-model="pinForm.current_pin" class="w-full border border-gray-300 rounded-md px-3 py-2" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Nouveau PIN</label>
                        <input type="password" x-model="pinForm.new_pin" class="w-full border border-gray-300 rounded-md px-3 py-2" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Confirmer le nouveau PIN</label>
                        <input type="password" x-model="pinForm.confirm_pin" class="w-full border border-gray-300 rounded-md px-3 py-2" required>
                    </div>
                </div>
                
                <div class="flex justify-end mt-6">
                    <button type="submit" class="bg-red-600 hover:bg-red-700 text-white px-6 py-2 rounded-md">
                        <i class="fas fa-key mr-2"></i>Changer le PIN
                    </button>
                </div>
            </form>
        </div>

        <!-- Security Preferences -->
        <div class="settings-card bg-white rounded-lg shadow p-6">
            <h3 class="text-lg font-medium text-gray-900 mb-6">Préférences de Sécurité</h3>
            
            <div class="space-y-4">
                <div class="flex items-center justify-between">
                    <div>
                        <label class="text-sm font-medium text-gray-700">Déconnexion automatique</label>
                        <p class="text-xs text-gray-500">Se déconnecter après inactivité</p>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" x-model="security.auto_logout" class="sr-only peer">
                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                    </label>
                </div>
                
                <div x-show="security.auto_logout">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Délai (minutes)</label>
                    <select x-model="security.auto_logout_time" class="w-full border border-gray-300 rounded-md px-3 py-2">
                        <option value="15">15 minutes</option>
                        <option value="30">30 minutes</option>
                        <option value="60">1 heure</option>
                        <option value="120">2 heures</option>
                    </select>
                </div>
                
                <div class="flex items-center justify-between">
                    <div>
                        <label class="text-sm font-medium text-gray-700">Notifications de connexion</label>
                        <p class="text-xs text-gray-500">Être notifié des nouvelles connexions</p>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" x-model="security.login_notifications" class="sr-only peer">
                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                    </label>
                </div>
                
                <div class="flex items-center justify-between">
                    <div>
                        <label class="text-sm font-medium text-gray-700">Journal d'activité</label>
                        <p class="text-xs text-gray-500">Enregistrer toutes les actions</p>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" x-model="security.activity_log" class="sr-only peer">
                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                    </label>
                </div>
            </div>
            
            <div class="flex justify-end mt-6">
                <button @click="updateSecurity()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-md">
                    <i class="fas fa-save mr-2"></i>Enregistrer
                </button>
            </div>
        </div>
    </div>

    <!-- Notifications Tab -->
    <div x-show="activeTab === 'notifications'" class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <!-- Email Notifications -->
        <div class="settings-card bg-white rounded-lg shadow p-6">
            <h3 class="text-lg font-medium text-gray-900 mb-6">Notifications Email</h3>
            
            <div class="space-y-4">
                <div class="flex items-center justify-between">
                    <div>
                        <label class="text-sm font-medium text-gray-700">Alertes de stock faible</label>
                        <p class="text-xs text-gray-500">Recevoir des emails pour les stocks faibles</p>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" x-model="notifications.email.low_stock_alerts" class="sr-only peer">
                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                    </label>
                </div>
                
                <div class="flex items-center justify-between">
                    <div>
                        <label class="text-sm font-medium text-gray-700">Rapports de ventes</label>
                        <p class="text-xs text-gray-500">Recevoir les rapports quotidiens</p>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" x-model="notifications.email.sales_reports" class="sr-only peer">
                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                    </label>
                </div>
                
                <div class="flex items-center justify-between">
                    <div>
                        <label class="text-sm font-medium text-gray-700">Alertes système</label>
                        <p class="text-xs text-gray-500">Notifications d'erreurs et mises à jour</p>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" x-model="notifications.email.system_alerts" class="sr-only peer">
                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                    </label>
                </div>
            </div>
        </div>

        <!-- Browser Notifications -->
        <div class="settings-card bg-white rounded-lg shadow p-6">
            <h3 class="text-lg font-medium text-gray-900 mb-6">Notifications Navigateur</h3>
            
            <div class="space-y-4">
                <div class="flex items-center justify-between">
                    <div>
                        <label class="text-sm font-medium text-gray-700">Notifications push</label>
                        <p class="text-xs text-gray-500">Recevoir des notifications dans le navigateur</p>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" x-model="notifications.browser.push_notifications" class="sr-only peer">
                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                    </label>
                </div>
                
                <div class="flex items-center justify-between">
                    <div>
                        <label class="text-sm font-medium text-gray-700">Sons de notification</label>
                        <p class="text-xs text-gray-500">Jouer un son pour les notifications</p>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" x-model="notifications.sound.enabled" class="sr-only peer">
                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                    </label>
                </div>
            </div>
            
            <div class="flex justify-end mt-6">
                <button @click="updateNotifications()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-md">
                    <i class="fas fa-save mr-2"></i>Enregistrer
                </button>
            </div>
        </div>
    </div>

    <!-- Recent Activity (shown in profile tab) -->
    <div x-show="activeTab === 'profile'" class="mt-8">
        <div class="settings-card bg-white rounded-lg shadow p-6">
            <h3 class="text-lg font-medium text-gray-900 mb-6">Activité Récente</h3>
            
            <div class="space-y-4">
                <template x-for="activity in recentActivities" :key="activity.id">
                    <div class="activity-item">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-sm font-medium text-gray-900" x-text="activity.action_type"></p>
                                <p class="text-xs text-gray-500" x-text="activity.description"></p>
                            </div>
                            <div class="text-right">
                                <span class="text-xs text-gray-500" x-text="activity.formatted_time"></span>
                                <span class="ml-2 px-2 py-1 text-xs font-medium rounded-full"
                                      :class="{
                                          'bg-green-100 text-green-800': activity.status === 'success',
                                          'bg-red-100 text-red-800': activity.status === 'error',
                                          'bg-yellow-100 text-yellow-800': activity.status === 'warning'
                                      }"
                                      x-text="activity.status">
                                </span>
                            </div>
                        </div>
                    </div>
                </template>
                
                <div x-show="recentActivities.length === 0" class="text-center text-gray-500 py-4">
                    Aucune activité récente
                </div>
            </div>
        </div>
    </div>
</main>
{% endblock %}

{% block extra_scripts %}
<script>
function settingsManager() {
    return {
        activeTab: 'profile',
        user: {},
        profile: {
            first_name: '',
            last_name: '',
            email: '',
            phone: '',
            photo_url: ''
        },
        preferences: {
            language: 'fr',
            currency: 'MRU',
            decimal_places: 2,
            theme: 'light',
            auto_save: true,
            show_tooltips: true,
            compact_view: false
        },
        security: {
            auto_logout: false,
            auto_logout_time: 30,
            login_notifications: true,
            activity_log: true
        },
        notifications: {
            email: {
                low_stock_alerts: true,
                sales_reports: true,
                system_alerts: true
            },
            browser: {
                push_notifications: false
            },
            sound: {
                enabled: false
            }
        },
        pinForm: {
            current_pin: '',
            new_pin: '',
            confirm_pin: ''
        },
        recentActivities: [],
        
        init() {
            this.loadUserInfo();
            this.loadPreferences();
            this.loadNotifications();
        },
        
        async loadUserInfo() {
            try {
                const response = await apiFetch('/api/settings/user-info');
                if (response.success) {
                    this.user = response.user;
                    this.profile = {
                        first_name: response.user.first_name || '',
                        last_name: response.user.last_name || '',
                        email: response.user.email || '',
                        phone: response.user.phone || '',
                        photo_url: response.user.photo_url || ''
                    };
                    this.recentActivities = response.activities || [];
                }
            } catch (error) {
                console.error('Error loading user info:', error);
            }
        },
        
        async loadPreferences() {
            try {
                const response = await apiFetch('/api/settings/preferences');
                if (response.success) {
                    this.preferences = { ...this.preferences, ...response.preferences };
                }
            } catch (error) {
                console.error('Error loading preferences:', error);
            }
        },
        
        async loadNotifications() {
            try {
                const response = await apiFetch('/api/settings/notifications');
                if (response.success) {
                    this.notifications = { ...this.notifications, ...response.notifications };
                }
            } catch (error) {
                console.error('Error loading notifications:', error);
            }
        },
        
        async updateProfile() {
            try {
                const response = await apiFetch('/api/settings/update-profile', {
                    method: 'POST',
                    body: this.profile
                });
                
                if (response.success) {
                    this.showNotification('Profil mis à jour avec succès', 'success');
                } else {
                    this.showNotification(response.error || 'Erreur lors de la mise à jour', 'error');
                }
            } catch (error) {
                console.error('Error updating profile:', error);
                this.showNotification('Erreur lors de la mise à jour du profil', 'error');
            }
        },
        
        async updatePreferences() {
            try {
                const response = await apiFetch('/api/settings/update-preferences', {
                    method: 'POST',
                    body: this.preferences
                });
                
                if (response.success) {
                    this.showNotification('Préférences mises à jour avec succès', 'success');
                    
                    // Apply language change if needed
                    if (response.reload_required) {
                        setTimeout(() => {
                            window.location.reload();
                        }, 1000);
                    }
                } else {
                    this.showNotification(response.error || 'Erreur lors de la mise à jour', 'error');
                }
            } catch (error) {
                console.error('Error updating preferences:', error);
                this.showNotification('Erreur lors de la mise à jour des préférences', 'error');
            }
        },
        
        async updateSecurity() {
            try {
                const response = await apiFetch('/api/settings/update-security', {
                    method: 'POST',
                    body: this.security
                });
                
                if (response.success) {
                    this.showNotification('Paramètres de sécurité mis à jour', 'success');
                } else {
                    this.showNotification(response.error || 'Erreur lors de la mise à jour', 'error');
                }
            } catch (error) {
                console.error('Error updating security:', error);
                this.showNotification('Erreur lors de la mise à jour des paramètres de sécurité', 'error');
            }
        },
        
        async updateNotifications() {
            try {
                const response = await apiFetch('/api/settings/update-notifications', {
                    method: 'POST',
                    body: this.notifications
                });
                
                if (response.success) {
                    this.showNotification('Préférences de notification mises à jour', 'success');
                } else {
                    this.showNotification(response.error || 'Erreur lors de la mise à jour', 'error');
                }
            } catch (error) {
                console.error('Error updating notifications:', error);
                this.showNotification('Erreur lors de la mise à jour des notifications', 'error');
            }
        },
        
        async updatePin() {
            if (this.pinForm.new_pin !== this.pinForm.confirm_pin) {
                this.showNotification('Les PINs ne correspondent pas', 'error');
                return;
            }
            
            if (this.pinForm.new_pin.length < 4) {
                this.showNotification('Le PIN doit contenir au moins 4 chiffres', 'error');
                return;
            }
            
            try {
                const response = await apiFetch('/api/settings/update-pin', {
                    method: 'POST',
                    body: {
                        current_pin: this.pinForm.current_pin,
                        new_pin: this.pinForm.new_pin
                    }
                });
                
                if (response.success) {
                    this.pinForm = { current_pin: '', new_pin: '', confirm_pin: '' };
                    this.showNotification('PIN mis à jour avec succès', 'success');
                } else {
                    this.showNotification(response.error || 'Erreur lors de la mise à jour', 'error');
                }
            } catch (error) {
                console.error('Error updating PIN:', error);
                this.showNotification('Erreur lors de la mise à jour du PIN', 'error');
            }
        },
        
        async uploadPhoto(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const formData = new FormData();
            formData.append('photo', file);
            
            try {
                const response = await fetch('/api/settings/upload-photo', {
                    method: 'POST',
                    body: formData,
                    credentials: 'same-origin'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    this.profile.photo_url = result.photo_url;
                    this.showNotification('Photo mise à jour avec succès', 'success');
                } else {
                    this.showNotification(result.error || 'Erreur lors du téléchargement', 'error');
                }
            } catch (error) {
                console.error('Error uploading photo:', error);
                this.showNotification('Erreur lors du téléchargement de la photo', 'error');
            }
        },
        
        showNotification(message, type = 'info') {
            if (window.showNotification) {
                window.showNotification(message, type);
            } else {
                alert(message);
            }
        }
    };
}
</script>
<style>
[x-cloak] { display: none !important; }
</style>
{% endblock %}