<!DOCTYPE html>
<html>
<head>
    <title>Dashboard Debug Test</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <h1>Dashboard Debug Test</h1>
    
    <h2>Top Products Container:</h2>
    <div id="topProducts" style="border: 1px solid red; min-height: 100px; padding: 10px;">
        Loading...
    </div>
    
    <h2>Sales Chart Container:</h2>
    <canvas id="salesChart" style="border: 1px solid blue; width: 400px; height: 200px;"></canvas>
    
    <h2>Debug Info:</h2>
    <div id="debugInfo"></div>
    
    <script>
        let salesChart;
        
        // Test top products function
        async function loadTopProducts() {
            try {
                console.log('Loading top products...');
                const response = await fetch('/api/dashboard/top-products');
                const data = await response.json();
                
                console.log('Top products response:', data);
                document.getElementById('debugInfo').innerHTML += `<p><strong>Top Products API Response:</strong> ${JSON.stringify(data)}</p>`;
                
                if (data.success && data.products && data.products.length > 0) {
                    const container = document.getElementById('topProducts');
                    container.innerHTML = '';
                    
                    data.products.forEach((product, index) => {
                        const productElement = document.createElement('div');
                        productElement.style.cssText = 'border: 1px solid gray; margin: 5px; padding: 10px;';
                        productElement.innerHTML = `
                            <strong>${index + 1}. ${product.name}</strong><br>
                            Quantité: ${product.quantity_sold} unités<br>
                            Total: ${product.total_sales} MRU<br>
                            Catégorie: ${product.category}
                        `;
                        container.appendChild(productElement);
                    });
                } else {
                    document.getElementById('topProducts').innerHTML = '<p>No products found or API error</p>';
                }
            } catch (error) {
                console.error('Error loading top products:', error);
                document.getElementById('debugInfo').innerHTML += `<p style="color:red;"><strong>Top Products Error:</strong> ${error}</p>`;
            }
        }
        
        // Test sales chart function
        async function loadSalesChart() {
            try {
                console.log('Loading sales chart...');
                const response = await fetch('/api/dashboard/sales-chart');
                const data = await response.json();
                
                console.log('Sales chart response:', data);
                document.getElementById('debugInfo').innerHTML += `<p><strong>Sales Chart API Response:</strong> ${JSON.stringify(data)}</p>`;
                
                if (data.success && data.daily) {
                    const ctx = document.getElementById('salesChart').getContext('2d');
                    
                    if (salesChart) {
                        salesChart.destroy();
                    }
                    
                    salesChart = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: data.daily.labels,
                            datasets: [{
                                label: 'Ventes (MRU)',
                                data: data.daily.data,
                                backgroundColor: 'rgba(59, 130, 246, 0.5)',
                                borderColor: 'rgba(59, 130, 246, 1)',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            scales: {
                                y: {
                                    beginAtZero: true
                                }
                            }
                        }
                    });
                } else {
                    document.getElementById('debugInfo').innerHTML += '<p style="color:red;">Sales chart data missing or API error</p>';
                }
            } catch (error) {
                console.error('Error loading sales chart:', error);
                document.getElementById('debugInfo').innerHTML += `<p style="color:red;"><strong>Sales Chart Error:</strong> ${error}</p>`;
            }
        }
        
        // Test login and load functions
        async function testDashboard() {
            try {
                // Test login
                console.log('Testing login...');
                const loginResponse = await fetch('/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        username: 'admin',
                        pin: '1234'
                    })
                });
                
                console.log('Login response:', loginResponse.status);
                document.getElementById('debugInfo').innerHTML += `<p><strong>Login Status:</strong> ${loginResponse.status}</p>`;
                
                // Wait a bit then load dashboard components
                setTimeout(() => {
                    loadTopProducts();
                    loadSalesChart();
                }, 1000);
                
            } catch (error) {
                console.error('Error testing dashboard:', error);
                document.getElementById('debugInfo').innerHTML += `<p style="color:red;"><strong>Test Error:</strong> ${error}</p>`;
            }
        }
        
        // Start test when page loads
        document.addEventListener('DOMContentLoaded', testDashboard);
    </script>
</body>
</html>
